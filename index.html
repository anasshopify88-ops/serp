<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>أداة محاكاة نتائج جوجل (مجانية 100% — تعمل محليًا)</title>

<!-- WebLLM (تشغيل النموذج داخل المتصفح) -->
<script src="https://unpkg.com/@mlc-ai/web-llm@0.2.78/dist/index.min.js"></script>

<style>
  :root{
    --bg:#f6f8fb; --text:#0f172a; --muted:#6b7280; --card:#ffffff; --border:#e5e7eb;
    --primary:#2563eb; --g-blue:#1a0dab; --g-url:#3c4043; --g-desc:#4d5156;
    --shadow:0 10px 30px rgba(2,8,23,.08); --radius:18px;
    --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
  }
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.65 Arial, Helvetica, sans-serif}
  .wrap{max-width:1100px;margin:24px auto;padding:0 12px 40px}
  .card,.preview{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow)}
  .card{padding:16px}
  .preview{padding:16px;position:sticky;top:16px}
  .row{display:grid;gap:20px;grid-template-columns:minmax(0,1.1fr) minmax(0,0.9fr)}
  @media (max-width:1024px){ .row{grid-template-columns:1fr} }

  textarea{width:100%;min-height:160px;padding:14px;border:1px solid var(--border);border-radius:14px;background:#fff0}
  input[type=text]{width:100%;padding:14px;border:1px solid var(--border);border-radius:14px;background:#fff0}
  .btn{padding:12px 14px;border-radius:12px;border:1px solid var(--border);cursor:pointer;background:#fff0}
  .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
  .btn.loading{opacity:.7;pointer-events:none}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{padding:8px 12px;border:1px solid var(--border);border-radius:999px;font-size:12px}
  .status{font-size:12px;margin-top:8px}
  .status.ok{color:var(--ok)} .status.warn{color:var(--warn)} .status.bad{color:var(--bad)} .hidden{display:none}

  .label{display:flex;align-items:center;justify-content:space-between;margin:8px 0;font-weight:700}
  .meters{display:flex;gap:8px;align-items:center}
  .meter{font-size:12px;border:1px solid var(--border);border-radius:999px;padding:6px 10px}
  .state{font-size:12px;font-weight:800}
  .state.ok{color:var(--ok)} .state.warn{color:var(--warn)} .state.bad{color:var(--bad)}

  .serp{display:flex;flex-direction:column;gap:3px}
  .serp .title{font:800 clamp(18px,2.2vw,22px)/1.3 Arial;color:var(--g-blue);margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .serp .url{color:var(--g-url);font:14px/1.7 Arial;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .serp .desc{color:var(--g-desc);font:15px/1.4 Arial;margin:0;white-space:pre-line}
</style>
</head>
<body>
<div class="wrap">
  <h1 style="margin:0 0 10px">أداة محاكاة نتائج جوجل — تعمل محليًا 100%</h1>
  <div class="status warn" id="gpuNote">سيتم تحميل النموذج للتشغيل على جهازك (مرة واحدة). لا توجد اتصالات خارجية.</div>

  <div class="row">
    <!-- AI -->
    <section class="card">
      <h2 style="margin:0 0 8px;font-size:16px">إنشاء العنوان والوصف والرابط تلقائيًا</h2>
      <textarea id="raw" placeholder="الصق وصف المنتج/الخدمة/المقال (حتى 12000 حرف)"></textarea>
      <div class="chips">
        <span class="chip" id="winfo">0 كلمة</span>
        <span class="chip">نموذج: <span id="modelName">Phi-3.5-mini-instruct (WebLLM)</span></span>
      </div>
      <div style="display:flex;gap:10px;margin-top:10px">
        <button class="btn primary" id="genBtn">توليد</button>
        <button class="btn" id="trimBtn">قصّ الحدود</button>
        <button class="btn" id="clearBtn">مسح</button>
      </div>
      <div id="status" class="status hidden"></div>
    </section>

    <!-- Fields -->
    <section class="card">
      <div class="label">
        <label for="title">العنوان (≤ 60)</label>
        <div class="meters">
          <span class="meter" id="titleCount">0</span>
          <span class="state" id="titleState">—</span>
        </div>
      </div>
      <input type="text" id="title" placeholder="العنوان">

      <div class="label" style="margin-top:14px">
        <label for="meta">وصف الميتا (≤ 160)</label>
        <div class="meters">
          <span class="meter" id="metaCount">0</span>
          <span class="state" id="metaState">—</span>
        </div>
      </div>
      <textarea id="meta" placeholder="الوصف"></textarea>

      <div class="label" style="margin-top:14px">
        <label for="url">الرابط</label>
        <div class="meters"><span class="meter" id="urlCount">0</span></div>
      </div>
      <input type="text" id="url" placeholder="https://yourdomain.com/مسار-الصفحة">
    </section>

    <!-- Preview -->
    <section class="preview">
      <div class="serp">
        <h3 class="title" id="pTitle">عنوان تجريبي لنتيجة البحث</h3>
        <p class="url"><span dir="ltr" id="pUrl">yourdomain.com/مسار-تجريبي</span></p>
        <p class="desc" id="pDesc">وصف ميتا تجريبي يظهر على سطرين بحد أقصى، مع قصّ ذكي للحروف.</p>
      </div>
    </section>
  </div>
</div>

<script>
/* ===== قياس عرض نص للمعاينة ===== */
(function(){ const c=document.createElement('canvas'),x=c.getContext('2d'); window.measurePx=(t,f)=>{x.font=f; return x.measureText(t==null?'':String(t)).width};})();
const FONTS = { title:'800 22px Arial, Helvetica, sans-serif', desc:'normal 15px Arial, Helvetica, sans-serif', url:'normal 14px Arial, Helvetica, sans-serif' };
const ELLIPSIS='…', TITLE_MAX=60, META_MAX=160;
const $=s=>document.querySelector(s);

/* ===== حالات/عدادات ===== */
const raw=$('#raw'), genBtn=$('#genBtn'), trimBtn=$('#trimBtn'), clearBtn=$('#clearBtn'), statusEl=$('#status');
const title=$('#title'), meta=$('#meta'), url=$('#url');
const pTitle=$('#pTitle'), pDesc=$('#pDesc'), pUrl=$('#pUrl');
const titleCount=$('#titleCount'), metaCount=$('#metaCount'), urlCount=$('#urlCount');
const titleState=$('#titleState'), metaState=$('#metaState'); const winfo=$('#winfo');

/* ===== أدوات نصية ===== */
const charCount = s => Array.from(String(s||'')).length;
const clean = s => String(s||'').replace(/\s+/g,' ').trim();
const stripEmoji = s => String(s||'').replace(/[\p{Extended_Pictographic}\u{1F3FB}-\u{1FAFF}\u{2600}-\u{27BF}]/gu,'');
function truncateSmart(text, limit){
  const arr=Array.from(text||''); if (arr.length<=limit) return text||'';
  const sliced=arr.slice(0,limit).join(''); const cut=sliced.lastIndexOf(' ');
  return (cut>0?sliced.slice(0,cut):sliced) + ELLIPSIS;
}
function enforceTitle(t){
  let out=clean(stripEmoji(t||'')); if(!out) out='عنوان مناسب للصفحة';
  if (charCount(out)>TITLE_MAX) out=truncateSmart(out, TITLE_MAX); return out;
}
function enforceMeta(m){
  let out=clean(stripEmoji(m||'')); if(!out) out='وصف موجز جذاب يوضح الفائدة الرئيسية ويشجع على النقر.';
  if (charCount(out)>META_MAX) out=truncateSmart(out, META_MAX); return out;
}
function slugFromTitle(t){
  let s = Array.from(String(t||'')).filter(ch=>/[\u0600-\u06FFA-Za-z0-9 \-]/.test(ch)).join('');
  s = s.replace(/\s+/g,'-').replace(/\-+/g,'-').replace(/^\-|\-$/g,'').toLowerCase();
  return s || 'صفحة-جديدة';
}
function extractDomain(raw){
  if(!raw) return 'yourdomain.com';
  let s=raw.trim().replace(/^https?:\/\//i,'').replace(/^www\./i,''); s=s.split('/')[0].replace(/\/+$/,'');
  return s||'yourdomain.com';
}
function render(){
  const tRaw = clean(title.value);
  const mRaw = clean(meta.value);
  const uRaw = clean(url.value);

  titleCount.textContent = charCount(tRaw);
  titleState.textContent = charCount(tRaw)>60?'طويل':(charCount(tRaw)<30?'قصير':'مناسب');
  titleState.className = 'state ' + (charCount(tRaw)>60?'bad':(charCount(tRaw)<30?'warn':'ok'));

  metaCount.textContent = charCount(mRaw);
  metaState.textContent = charCount(mRaw)>160?'طويل':(charCount(mRaw)<80?'قصير':'مناسب');
  metaState.className = 'state ' + (charCount(mRaw)>160?'bad':(charCount(mRaw)<80?'warn':'ok'));

  urlCount.textContent = charCount(uRaw);

  // معاينة
  const tDisp = charCount(tRaw)>TITLE_MAX ? truncateSmart(tRaw,TITLE_MAX) : tRaw;
  pTitle.textContent = tDisp || 'عنوان تجريبي لنتيجة البحث';

  const linePx = pDesc.getBoundingClientRect().width || 500;
  const tokens = String(mRaw).replace(/\n+/g,' ').split(/(\s+)/);
  let lines=['','']; let i=0;
  const fits=(curr,tok)=>measurePx(curr+tok,FONTS.desc)<=linePx;
  for (const tok of tokens){
    if (fits(lines[i],tok)){ lines[i]+=tok; }
    else { i++; if(i>1){ let second=lines[1].trimEnd(); while(second && measurePx(second+ELLIPSIS,FONTS.desc)>linePx){ second=second.replace(/\s*\S+$/,''); } lines[1]=second+(second?ELLIPSIS:''); break; }
           else { if (measurePx(tok,FONTS.desc)<=linePx){ lines[i]=tok.replace(/^\s+/,''); }
                  else { let piece=''; for(let j=0;j<tok.length;j++){ const c=piece+tok[j]; if (measurePx(c,FONTS.desc)<=linePx) piece=c; else break; } lines[i]=piece; } } }
  }
  pDesc.textContent = (lines[0]+(lines[1]?'\n'+lines[1]: '')).trim();

  const niceUrl = (uRaw||('https://'+extractDomain(uRaw)+'/'+slugFromTitle(tDisp||'صفحة-جديدة')))
                  .replace(/^https?:\/\//,'').replace(/^www\./,'');
  pUrl.textContent = niceUrl;
}

/* ===== تحميل وتشغيل WebLLM محليًا ===== */
let engine = null;
const MODEL = "Phi-3.5-mini-instruct-q4f16_1-MLC"; // صغير وسريع نسبيًا
document.getElementById('modelName').textContent = "Phi-3.5-mini-instruct";

async function ensureEngine(){
  if (engine) return engine;
  setStatus('warn','جاري تهيئة النموذج المحلي... قد يستغرق أول تشغيل دقيقة (سيُخزن في الكاش).');
  engine = await webllm.CreateWebWorkerMLCEngine(
    MODEL,
    {
      initProgressCallback: (p) => {
        if (p.text) setStatus('warn', 'تحميل: ' + p.text);
      },
      // يُستخدم WebGPU تلقائيًا إن توفر، وإلا يسقط على WASM/CPU
    }
  );
  setStatus('ok','جاهز للتوليد محليًا.');
  return engine;
}

function setStatus(kind,msg){
  statusEl.className = 'status ' + (kind||'') + (msg?'':' hidden');
  statusEl.textContent = msg||'';
}

/* ===== التوليد ===== */
function buildPrompt(userText){
  return [
    { role:"system", content:
`أنت خبير سيو عربي محترف. أعد JSON فقط بالمفاتيح: { "title": "", "meta": "", "slug": "" }.
القيود:
- "title": ≤ 60 حرف، عربي واضح بلا إيموجي/زخرفة/تكرار، يركز على الفائدة.
- "meta": ≤ 160 حرف، جذاب مختصر لا يكرر العنوان حرفياً.
- "slug": مشتق من العنوان، أحرف عربية/لاتينية وأرقام وواصلة (-) فقط.
أعد JSON فقط بلا أي نص إضافي.` },
    { role:"user", content: "الوصف:\n" + userText + "\nأعد JSON فقط." }
  ];
}

function tryParseJSONBlock(s){
  try { return JSON.parse(s); } catch {}
  const m = typeof s==="string" && s.match(/\{[\s\S]*\}/);
  if (m){ try { return JSON.parse(m[0]); } catch {} }
  return null;
}

async function generate(){
  const txt = clean(raw.value);
  if (!txt){ setStatus('bad','الصق وصفًا واضحًا أولاً.'); return; }

  genBtn.classList.add('loading'); genBtn.textContent='... جاري التوليد';
  setStatus('warn','توليد محلي قيد التنفيذ...');
  try{
    await ensureEngine();
    const res = await engine.chat.completions.create({
      messages: buildPrompt(txt),
      temperature: 0.2,
      stream: false
    });
    const content = res?.choices?.[0]?.message?.content || "";
    let out = tryParseJSONBlock(content) || {};
    // تنظيف وحدود صارمة
    const t = enforceTitle(out.title||'');
    let m  = enforceMeta(out.meta||'');
    if (clean(m) === clean(t)) m = enforceMeta(m + ' — تفاصيل موجزة إضافية.');
    const domain = extractDomain(url.value || 'yourdomain.com');
    const s = slugFromTitle(t);
    title.value = t; meta.value = m; url.value = 'https://' + domain + '/' + s;
    setStatus('ok','تم التوليد محليًا (بدون أي API).');
    render();
  }catch(e){
    setStatus('bad','فشل التوليد المحلي: ' + String(e).slice(0,200));
  }finally{
    genBtn.classList.remove('loading'); genBtn.textContent='توليد';
  }
}

/* ===== أحداث واجهة ===== */
function updateWordCount(){ const wc=(raw.value.trim().match(/[\p{L}\p{N}’']+/gu)||[]).length; winfo.textContent=`${wc} كلمة`; }
raw.addEventListener('input', ()=>{ updateWordCount(); });
title.addEventListener('input', render); meta.addEventListener('input', render); url.addEventListener('input', render);

trimBtn.addEventListener('click', ()=>{
  if (charCount(title.value)>TITLE_MAX) title.value = truncateSmart(title.value, TITLE_MAX);
  if (charCount(meta.value)>META_MAX)   meta.value  = truncateSmart(meta.value, META_MAX);
  // حدّث السُّلَج من العنوان
  const domain = extractDomain(url.value || 'yourdomain.com');
  url.value = 'https://' + domain + '/' + slugFromTitle(title.value);
  render();
});
clearBtn.addEventListener('click', ()=>{ raw.value=''; title.value=''; meta.value=''; url.value=''; updateWordCount(); render(); });
genBtn.addEventListener('click', generate);

/* بداية */
updateWordCount(); render();
</script>
</body>
</html>
