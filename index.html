<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>أداة محاكاة مجانية لنتائج جوجل من أنس راشد</title>
<style>
  :root{
    --bg:#f6f8fb; --text:#0f172a; --muted:#6b7280; --card:#ffffff; --border:#e5e7eb;
    --primary:#2563eb; --g-blue:#1a0dab; --g-url:#3c4043; --g-desc:#4d5156;
    --shadow:0 10px 30px rgba(2,8,23,.08); --radius:18px;
    --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
  }
  .dark{ --bg:#0b1220; --text:#e5e7eb; --muted:#9aa4b2; --card:#0f172a; --border:#1f2a44; --g-blue:#8ab4f8; --g-url:#bdc1c6; --g-desc:#bdc1c6; --shadow:0 10px 30px rgba(0,0,0,.45); }
  *{box-sizing:border-box}
  html,body{height:100%; overflow-x:hidden; width:100%; max-width:100%; -webkit-text-size-adjust:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.65 Arial, Helvetica, sans-serif}
  @media (min-width:1280px){ body{font-size:16px} }

  .wrap{max-width:1200px;margin:24px auto;padding:0 12px 40px;width:100%}
  header{display:flex;align-items:center;justify-content:space-between;gap:14px;margin-bottom:14px;flex-wrap:wrap;min-width:0}
  .brand{display:flex;align-items:center;gap:12px;min-width:0}
  .avatar{width:72px;height:72px;border-radius:50%;object-fit:contain;background:#fff;border:1px solid var(--border);box-shadow:var(--shadow)}
  .tool-name{font-weight:800;font-size:clamp(18px,2.2vw,28px);line-height:1.2;white-space:nowrap}
  .header-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;min-width:0}
  .toggle,.nav-btn{padding:10px 14px;border:1px solid var(--border);border-radius:999px;background:var(--card);cursor:pointer}
  .nav-btn.home{background:#000;color:#fff;border-color:#000}

  /* تخطيط الديسكتوب كما هو */
  .row{
    display:grid; gap:16px; align-items:stretch;
    grid-template-columns: minmax(0,1.1fr) minmax(0,0.9fr);
    grid-template-rows: auto 1fr;
    grid-template-areas:
      "fields ai"
      "fields preview";
    min-width:0;
  }
  .row > *{min-width:0}

  /* الجوال: نفس ترتيبك، مع تحسين عرض الهيدر ومنع أي تمدد أفقي */
  @media (max-width:1024px){
    .row{
      grid-template-columns:1fr;
      grid-template-rows:auto auto auto;
      grid-template-areas:
        "ai"
        "preview"
        "fields";
      gap:12px;
    }
  }
  @media (max-width:640px){
    header{flex-direction:column;justify-content:flex-start;gap:10px;text-align:center}
    .brand{width:100%;flex-direction:column;gap:10px;align-items:center}
    .avatar{width:96px;height:96px}
    .tool-name{white-space:normal} /* العنوان تحت الصورة ويلف أسطر */
    .header-actions{width:100%;justify-content:center}
  }

  .card,.preview{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card{padding:16px}
  .preview{padding:16px; margin:0; height:100%}
  @media (max-width:1024px){ .preview{height:auto} }

  .fields .field:last-child{ margin-bottom: 0 }

  .ai-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
  .ai-actions{display:flex;gap:8px;flex-wrap:wrap}
  .hint{font-size:12px;color:var(--muted)}
  .status{font-size:12px;margin-top:8px;display:flex;align-items:center;gap:8px}
  .status.ok{color:var(--ok)} .status.warn{color:var(--warn)} .status.bad{color:var(--bad)} .status.hidden{display:none}
  .err{margin-top:8px;font-size:12px;color:var(--bad)}

  textarea#rawInput{width:100%;max-width:100%;min-height:160px;max-height:48vh;resize:vertical;padding:14px;border:1px solid var(--border);border-radius:14px;background:#fff0;color:var(--text)}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#fff0;font-size:12px}

  .fields .field{margin-bottom:14px}
  .label{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px;font-weight:700;font-size:14px}
  input[type="text"], textarea:not(#rawInput){width:100%;padding:14px;border:1px solid var(--border);border-radius:14px;background:#fff0;color:var(--text)}
  textarea:not(#rawInput){min-height:110px;max-height:40vh;resize:vertical}
  .note{font-size:12px;color:var(--muted)}
  .meters{display:flex;align-items:center;gap:8px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
  .meter-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff0;font-weight:700}
  .state{font-weight:800}.ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
  .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
  button{padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#fff0;color:var(--text);cursor:pointer}
  button.primary{background:var(--primary);border-color:var(--primary);color:#fff}
  button.loading{opacity:.7;pointer-events:none}

  .serp{display:flex;flex-direction:column;gap:3px;width:100%; overflow-wrap:anywhere;word-break:break-word}
  /* ديسكتوب: سطر واحد مع ellipsis (كما هو) */
  .serp .title{font:800 clamp(18px,2.2vw,22px)/1.3 Arial, Helvetica, sans-serif;color:var(--g-blue);margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .serp .url{color:var(--g-url);font:normal 14px/1.7 Arial, Helvetica, sans-serif;margin:0 0 2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .serp .desc{color:var(--g-desc);font:normal 15px/1.4 Arial, Helvetica, sans-serif;margin:0;white-space:pre-line}
  /* جوال: عرض كامل بدون قص */
  @media (max-width:1024px){
    .serp .title, .serp .url{white-space:normal;overflow:visible;text-overflow:clip}
  }

  .foot-help{margin-top:10px;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap" id="app">
  <header>
    <div class="brand">
      <img id="avatar" class="avatar" alt="صورة أنس راشد" src="https://i.imgur.com/B3UkEQ0.jpg">
      <div class="tool-name">أداة محاكاة مجانية لنتائج جوجل من أنس راشد</div>
    </div>
    <div class="header-actions" role="group" aria-label="خيارات التنقل">
      <button id="backBtn" class="nav-btn" title="رجوع">رجوع</button>
      <a id="homeBtn" class="nav-btn home" href="https://anasrashed.com" title="الرئيسية">الرئيسية</a>
      <button id="darkBtn" class="toggle" aria-pressed="false" aria-label="تبديل الوضع الداكن">الوضع الداكن</button>
    </div>
  </header>

  <div class="row">
    <!-- يسار (يمتد صفّين): الحقول -->
    <section class="card fields" id="sec-fields" style="grid-area:fields">
      <div class="field">
        <div class="label">
          <label for="titleInput">العنوان (Title)</label>
          <div class="meters">
            <span class="meter-pill" id="titleCount">0 حرف</span>
            <span class="state" id="titleState">—</span>
          </div>
        </div>
        <input id="titleInput" type="text" placeholder="40–60 حرف">
      </div>

      <div class="field">
        <div class="label">
          <label for="descInput">الوصف (Meta)</label>
          <div class="meters">
            <span class="meter-pill" id="descCount">0 حرف</span>
            <span class="state" id="descState">—</span>
          </div>
        </div>
        <textarea id="descInput" placeholder="120–160 حرف"></textarea>
      </div>

      <div class="field">
        <div class="label">
          <label for="urlInput">الرابط (URL)</label>
          <div class="meters">
            <span class="meter-pill" id="urlCount">0 حرف</span>
            <span class="state" id="urlState">—</span>
          </div>
        </div>
        <input id="urlInput" type="text" placeholder="https://yourdomain.com/مسار-الصفحة">
      </div>

      <div class="btns">
        <button class="primary" id="copyTitleBtn">نسخ العنوان</button>
        <button class="primary" id="copyDescBtn">نسخ الوصف</button>
        <button class="primary" id="copyPreviewBtn">نسخ المعاينة كنص</button>
        <button id="clearBtn">مسح الحقول</button>
      </div>
    </section>

    <!-- يمين علوي: توليد -->
    <section class="card" id="sec-ai" style="grid-area:ai">
      <div class="ai-head">
        <h2 style="margin:0;font-size:16px">إنشاء العنوان والوصف والرابط تلقائيًا</h2>
        <div class="ai-actions">
          <button id="generateBtn" class="primary">توليد</button>
          <button id="clearAllBtn">مسح الكل</button>
        </div>
      </div>
      <p class="hint">الصق وصف المنتج/الخدمة/المقال (حتى 12000 حرف). لا يوجد توليد محلي — API فقط.</p>
      <textarea id="rawInput" placeholder="الصق وصفًا تفصيليًا هنا..."></textarea>
      <div class="chips">
        <span class="chip" id="wordInfo">0 كلمة</span>
        <span class="chip" id="aiMode">وضع: API</span>
      </div>
      <div id="status" class="status hidden"></div>
      <div id="aiErr" class="err" hidden></div>
    </section>

    <!-- يمين سفلي: المعاينة -->
    <section class="preview" id="sec-preview" style="grid-area:preview">
      <div class="serp" id="serp">
        <h3 class="title" id="pTitle">أداة محاكاة مجانية لنتائج بحث جوجل (SERP) من أنس راشد</h3>
        <p class="url"><span dir="ltr" id="pUrl">yourdomain.com/أداة-محاكاة-نتائج-بحث</span></p>
        <p class="desc" id="pDesc">وصف تجريبي.</p>
      </div>
      <div class="foot-help">• العنوان ≤ 60 — الوصف ≤ 160.</div>
    </section>
  </div>
</div>

<script>
const API_BASE = "https://seo-generate.anasshopify88.workers.dev";
const ENDPOINTS = { gen: API_BASE + "/api/generate", ping: API_BASE + "/ping", diag: API_BASE + "/diag" };

(function(){ const c=document.createElement('canvas'),x=c.getContext('2d'); window.measurePx=(t,f)=>{x.font=f; return x.measureText(t==null?'':String(t)).width}; })();
const FONTS = { title:'800 22px Arial, Helvetica, sans-serif', desc :'normal 15px Arial, Helvetica, sans-serif', url  :'normal 14px Arial, Helvetica, sans-serif' };
const ELLIPSIS='…', TITLE_MIN=40, TITLE_MAX=60, META_MIN=100, META_MAX=160;
const $=s=>document.querySelector(s);

const titleInput=$('#titleInput'), descInput=$('#descInput'), urlInput=$('#urlInput');
const pTitle=$('#pTitle'), pUrl=$('#pUrl'), pDesc=$('#pDesc'), serp=$('#serp');
const statusEl=$('#status'), aiErr=$('#aiErr');
const titleCountEl=$('#titleCount'), titleState=$('#titleState');
const descCountEl=$('#descCount'), descState=$('#descState');
const urlCountEl=$('#urlCount'), urlState=$('#urlState');
const rawInput=$('#rawInput'), generateBtn=$('#generateBtn'), clearAllBtn=$('#clearAllBtn');

function setStatus(kind, msg){
  statusEl.className = 'status ' + (kind||'') + (msg?'':' hidden');
  statusEl.textContent = msg||'';
}

const charCount = s => Array.from(String(s||'')).length;
const normalizeWS = s => String(s||'').replace(/\s+/g,' ').trim();
const cleanUrlForDisplay = raw => (raw||'').trim().replace(/^https?:\/\//i,'').replace(/^www\./i,'');
const extractDomain = raw => { if(!raw) return 'yourdomain.com'; let s=raw.trim().replace(/^https?:\/\//i,'').replace(/^www\./i,''); s=s.split('/')[0].replace(/\/+$/,''); return s||'yourdomain.com'; };
const slugFromTitle = t => { let s=Array.from(String(t||"")).filter(ch=>/[\u0600-\u06FFA-Za-z0-9 \-]/.test(ch)).join(''); s=s.replace(/\s+/g,'-').replace(/\-+/g,'-').replace(/^\-|\-$/g,'').toLowerCase(); return s||'صفحة-جديدة'; };
const availableWidth = el => Math.max(60, Math.floor(el.getBoundingClientRect().width));

function truncateByChars(text, limit){ const arr=Array.from(text||''); if(arr.length<=limit) return text||''; const sliced=arr.slice(0,limit).join(''); const lastSpace=sliced.lastIndexOf(' '); const base=lastSpace>0?sliced.slice(0,lastSpace):sliced; return base+ELLIPSIS; }

function midTruncateToFit(str, limitPx, font){
  if (measurePx(str,font)<=limitPx) return str;
  let start=0,end=str.length-1,out=str;
  while (start<end){ out=str.slice(0,start)+ELLIPSIS+str.slice(end+1); if (measurePx(out,font)<=limitPx) return out; (start <= (str.length-1-end))?start++:end--; }
  let base=''; for (let i=0;i<str.length;i++){ const c=base+str[i]; if (measurePx(c+ELLIPSIS,font)<=limitPx) base=c; else break; }
  return base+ELLIPSIS;
}

function render(){
  const isMobile = window.matchMedia('(max-width: 1024px)').matches;

  const titleRaw = normalizeWS(titleInput.value).trimStart();
  const enforcedTitle = isMobile
    ? titleRaw
    : (charCount(titleRaw) > TITLE_MAX) ? truncateByChars(titleRaw, TITLE_MAX) : titleRaw;

  titleCountEl.textContent = `${charCount(titleRaw)} حرف`;
  titleState.textContent = (charCount(titleRaw)>TITLE_MAX)?'طويل':(charCount(titleRaw)<TITLE_MIN?'قصير':'مناسب');
titleState.className = 'state ' + ((charCount(titleRaw)>TITLE_MAX)?'bad':(charCount(titleRaw)<TITLE_MIN)?'warn':'ok');
  pTitle.textContent = enforcedTitle || 'أداة محاكاة مجانية لنتائج بحث جوجل (SERP) من أنس راشد';

  const dom = extractDomain(urlInput.value || 'yourdomain.com');
  urlInput.value = 'https://' + dom + '/' + slugFromTitle(enforcedTitle || 'أداة-محاكاة-نتائج-بحث');

  if (isMobile){
    pUrl.textContent = cleanUrlForDisplay(urlInput.value || 'yourdomain.com/slug');
  }else{
    const urlLimit = availableWidth(pUrl.parentElement);
    pUrl.textContent = midTruncateToFit(cleanUrlForDisplay(urlInput.value || 'yourdomain.com/slug'), urlLimit, FONTS.url);
  }
  urlCountEl.textContent = `${charCount(urlInput.value)} حرف`; urlState.textContent='—'; urlState.className='state';

  const dRaw = descInput.value || '';
  descCountEl.textContent = `${charCount(dRaw)} حرف`;
  descState.textContent = (charCount(dRaw)>META_MAX)?'طويل':(charCount(dRaw)<META_MIN?'قصير':'مناسب');
  descState.className = 'state ' + ((charCount(dRaw)>160)?'bad':(charCount(dRaw)<80)?'warn':'ok');

  if (isMobile){
    pDesc.textContent = dRaw.trim();  // عرض كامل على الجوال
  }else{
    const linePx = availableWidth(pDesc);
    const tokens = String(dRaw).replace(/\n+/g,' ').split(/(\s+)/);
    let lines=['','']; let iLine=0;
    const fits=(curr,tok)=>measurePx(curr+tok, FONTS.desc)<=linePx;
    for (const tok of tokens){
      if (fits(lines[iLine], tok)){ lines[iLine]+=tok; }
      else { iLine++; if (iLine>1){
          let second = lines[1].trimEnd();
          while (second && measurePx(second+ELLIPSIS,FONTS.desc)>linePx){ second = second.replace(/\s*\S+$/,''); }
          lines[1]=second+(second?ELLIPSIS:''); break;
        } else {
          if (measurePx(tok,FONTS.desc)<=linePx){ lines[iLine]=tok.replace(/^\s+/,''); }
          else { let piece=''; for (let j=0;j<tok.length;j++){ const c=piece+tok[j]; if (measurePx(c,FONTS.desc)<=linePx) piece=c; else break; } lines[iLine]=piece; }
        }
      }
    }
    pDesc.textContent = (lines[0] + (lines[1]? '\n'+lines[1] : '')).trim();
  }
}

async function aiGenerate(raw){
  const controller = new AbortController();
  const timeout = setTimeout(()=>controller.abort(), 25000);
  let respText = "";
  try{
    const resp = await fetch(ENDPOINTS.gen, {
      method:'POST',
      headers:{'Content-Type':'application/json','Accept':'application/json'},
      body: JSON.stringify({ text: raw }),
      mode:'cors', cache:'no-store', signal: controller.signal
    });
    clearTimeout(timeout);
    respText = await resp.text();
    if (!resp.ok) throw new Error(respText || `HTTP ${resp.status}`);
    return JSON.parse(respText);
  }catch(err){ clearTimeout(timeout); throw err; }
}

function showErrorMessage(eText){ aiErr.hidden = false; aiErr.textContent = eText; }
function clearError(){ aiErr.hidden = true; aiErr.textContent = ""; }

async function generateFromRaw(){
  clearError(); setStatus('', '');
  let raw = rawInput.value || '';
  if (charCount(raw) > 12000) raw = Array.from(raw).slice(0,12000).join('');

  generateBtn.classList.add('loading'); generateBtn.textContent='... جاري التوليد';
  try{
    const out = await aiGenerate(raw);
    if (!out || !out.title || !out.meta){
      throw new Error('استجابة غير صالحة من الخادم.');
    }
    const title = (charCount(out.title)>TITLE_MAX) ? truncateByChars(out.title, TITLE_MAX) : out.title;
    const meta  = (charCount(out.meta )>META_MAX ) ? truncateByChars(out.meta , META_MAX ) : out.meta;

    titleInput.value = title;
    descInput.value  = meta;

    const dom = extractDomain(urlInput.value || 'yourdomain.com');
    const slug = out.slug || slugFromTitle(title);
    urlInput.value   = 'https://' + dom + '/' + slug;

    setStatus('ok', 'تم التوليد بنجاح عبر Cloudflare AI.');
    render();
  }catch(err){
    setStatus('bad', 'فشل الاتصال بالـAPI.');
    let msg = String(err||'');
    showErrorMessage('فشل التوليد: ' + msg);
  }finally{
    generateBtn.classList.remove('loading'); generateBtn.textContent='توليد';
  }
}

/* ========= init ========= */
(function init(){
  titleInput.value='أداة محاكاة مجانية لنتائج بحث جوجل (SERP) من أنس راشد';
  descInput.value='أنا أنس راشد مختص تحسين محركات البحث؛ أداة لكتابة عنوان ووصف ورابط مثالي يظهر بشكل احترافي في نتائج البحث.';
  urlInput.value='https://yourdomain.com/' + slugFromTitle(titleInput.value);

  render();
  window.addEventListener('resize', render); // لضمان السلوك الصحيح عند تغيير المقاس
  rawInput.addEventListener('input', ()=>{ const wc=(rawInput.value.trim().match(/[\p{L}\p{N}’']+/gu)||[]).length; document.querySelector('#wordInfo').textContent=`${wc} كلمة`; });
  titleInput.addEventListener('input', render);
  descInput .addEventListener('input', render);
  urlInput  .addEventListener('input', render);
  document.querySelector('#clearBtn').addEventListener('click', ()=>{ titleInput.value=''; descInput.value=''; urlInput.value=''; render(); });
  document.querySelector('#clearAllBtn').addEventListener('click', ()=>{ rawInput.value=''; document.querySelector('#wordInfo').textContent='0 كلمة'; });
  document.querySelector('#copyTitleBtn').addEventListener('click', ()=>navigator.clipboard.writeText(titleInput.value));
  document.querySelector('#copyDescBtn') .addEventListener('click', ()=>navigator.clipboard.writeText(descInput.value));
  document.querySelector('#copyPreviewBtn').addEventListener('click', ()=>navigator.clipboard.writeText([titleInput.value, cleanUrlForDisplay(urlInput.value), descInput.value].filter(Boolean).join('\n')));
  document.querySelector('#backBtn').addEventListener('click', ()=>history.back());
  document.querySelector('#darkBtn').addEventListener('click', ()=>{
    document.body.classList.toggle('dark');
    const on=document.body.classList.contains('dark');
    document.querySelector('#darkBtn').setAttribute('aria-pressed', on);
    document.querySelector('#darkBtn').textContent = on ? 'الوضع الفاتح' : 'الوضع الداكن';
  });
  document.querySelector('#generateBtn').addEventListener('click', ()=>{
    if (!rawInput.value.trim()){
      rawInput.value = [titleInput.value, descInput.value].join('\n');
      document.querySelector('#wordInfo').textContent=`${(rawInput.value.trim().match(/[\p{L}\p{N}’']+/gu)||[]).length} كلمة`;
    }
    generateFromRaw();
  });
})();
</script>
</body>
</html>
