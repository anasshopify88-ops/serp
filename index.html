<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>أداة محاكاة مجانية لنتائج جوجل من أنس راشد</title>
<style>
  :root{
    --bg:#f6f8fb; --text:#0f172a; --muted:#6b7280; --card:#ffffff; --border:#e5e7eb;
    --primary:#2563eb; --g-blue:#1a0dab; --g-url:#3c4043; --g-desc:#4d5156;
    --shadow:0 10px 30px rgba(2,8,23,.08); --radius:18px;
    --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
  }
  .dark{
    --bg:#0b1220; --text:#e5e7eb; --muted:#9aa4b2; --card:#0f172a; --border:#1f2a44;
    --g-blue:#8ab4f8; --g-url:#bdc1c6; --g-desc:#bdc1c6; --shadow:0 10px 30px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  html,body{height:100%; overflow-x:hidden; width:100%; max-width:100%; -webkit-text-size-adjust:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.65 Arial, Helvetica, sans-serif}
  @media (min-width:1280px){ body{font-size:16px} }
  img{max-width:100%; height:auto}
  .wrap{max-width:1200px;margin:24px auto;padding:0 12px 40px;width:100%}
  @media (max-width:480px){ .wrap{padding:0 10px 28px} }
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

  header{display:flex;align-items:center;justify-content:space-between;gap:14px;margin-bottom:14px;flex-wrap:wrap}
  .brand{display:flex;align-items:center;gap:12px}
  .avatar{
    width:72px;height:72px;border-radius:50%;object-fit:cover;background:#fff;
    border:1px solid var(--border);box-shadow:var(--shadow)
  }
  .tool-name{font-weight:800;font-size:clamp(18px,2.2vw,28px);line-height:1.2;white-space:nowrap}
  @media (max-width:700px){
    header{flex-direction:column;align-items:center;gap:10px}
    .brand{flex-direction:column;align-items:center;text-align:center}
    .avatar{width:104px;height:104px}
    .tool-name{font-size:clamp(16px,5vw,22px);max-width:92vw;white-space:nowrap}
    .header-actions{width:100%;justify-content:center;min-width:0}
  }
  .header-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .toggle,.nav-btn{padding:10px 14px;border:1px solid var(--border);border-radius:999px;background:var(--card);cursor:pointer}
  .nav-btn.home{background:#000;color:#fff;border-color:#000}
  .nav-btn:focus,.toggle:focus{outline:2px solid var(--primary);outline-offset:2px}

  /* ===== التخطيط الجديد ===== */
  .row{
    display:grid; gap:20px; align-items:start;
    grid-template-columns: minmax(0,1.1fr) minmax(0,0.9fr);
    grid-template-areas:
      "ai preview"
      "fields preview";
  }
  #sec-ai{grid-area:ai}
  #sec-fields{grid-area:fields}
  #sec-preview{grid-area:preview}
  @media (max-width:1024px){
    .row{grid-template-columns:1fr;grid-template-areas:"ai" "fields" "preview";gap:14px}
  }

  .card,.preview{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card{padding:16px}
  .preview{padding:16px; position:sticky; top:16px; align-self:start}

  .ai-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
  .ai-actions{display:flex;gap:8px;flex-wrap:wrap}
  .hint{font-size:12px;color:var(--muted)}
  .banner{font-size:12px;margin-top:8px;display:flex;align-items:center;gap:8px}
  .banner.ok{color:var(--ok)} .banner.warn{color:var(--warn)} .banner.bad{color:var(--bad)}
  textarea#rawInput{
    width:100%;max-width:100%;min-height:160px;max-height:48vh;resize:vertical;
    padding:14px;border:1px solid var(--border);border-radius:14px;background:#fff0;color:var(--text);
    overflow:auto;-webkit-overflow-scrolling:touch;
  }
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#fff0;font-size:12px}

  .fields .field{margin-bottom:14px}
  .label{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px;font-weight:700;font-size:14px}
  input[type="text"], textarea:not(#rawInput){
    width:100%;max-width:100%;padding:14px;border:1px solid var(--border);border-radius:14px;background:#fff0;color:var(--text);outline:none;
    overflow:auto;-webkit-overflow-scrolling:touch;
  }
  textarea:not(#rawInput){min-height:110px;max-height:40vh;resize:vertical}
  .note{font-size:12px;color:var(--muted)}
  .meters{display:flex;align-items:center;gap:8px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
  .meter-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff0;font-weight:700}
  .state{font-weight:800}.ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
  .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
  button{padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#fff0;color:var(--text);cursor:pointer}
  button.primary{background:var(--primary);border-color:var(--primary);color:#fff}
  button:focus{outline:2px solid var(--primary);outline-offset:2px}
  .loading{opacity:.7;pointer-events:none}

  .serp{display:flex;flex-direction:column;gap:3px;width:100%; overflow-wrap:anywhere;word-break:break-word}
  .serp .title{
    font:800 clamp(18px,2.2vw,22px)/1.3 Arial, Helvetica, sans-serif;color:var(--g-blue);margin:0;
    width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  }
  .serp .url{
    color:var(--g-url);font:normal 14px/1.7 Arial, Helvetica, sans-serif;margin:0 0 2px;
    width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  }
  .serp .desc{
    color:var(--g-desc);font:normal 15px/1.4 Arial, Helvetica, sans-serif;margin:0;
    width:100%;white-space:pre-line;
  }
  .foot-help{margin-top:10px;font-size:12px;color:var(--muted)}

  /* جوال */
  @media (max-width:700px){
    input[type="text"], textarea, button{font-size:16px}
  }
  @media (max-width:480px){
    .card,.preview{padding:14px;border-radius:14px}
    .note{font-size:11px}
    .nav-btn,.toggle{padding:9px 12px}
  }
</style>
</head>
<body>
<div class="wrap" id="app">
  <header>
    <div class="brand">
      <img id="avatar" class="avatar" alt="صورة أنس راشد" src="https://i.imgur.com/B3UkEQ0.jpg">
      <div class="tool-name">أداة محاكاة مجانية لنتائج جوجل من أنس راشد</div>
    </div>
    <div class="header-actions" role="group" aria-label="خيارات التنقل">
      <button id="backBtn" class="nav-btn" title="رجوع">رجوع</button>
      <button id="homeBtn" class="nav-btn home" title="الرئيسية">الرئيسية</button>
      <button id="darkBtn" class="toggle" aria-pressed="false" aria-label="تبديل الوضع الداكن">الوضع الداكن</button>
    </div>
  </header>

  <div class="row">
    <!-- ===== AI ===== -->
    <section class="card" id="sec-ai" aria-labelledby="aiTitle">
      <div class="ai-head">
        <h2 id="aiTitle" style="margin:0;font-size:16px">إنشاء العنوان والوصف والرابط تلقائيًا</h2>
        <div class="ai-actions">
          <button id="generateBtn" class="primary">توليد</button>
          <button id="clearAllBtn">مسح الكل</button>
        </div>
      </div>
      <p class="hint">الصق وصف المنتج/المقالة/الصفحة (حتى 3000 كلمة). بعد التوليد يمكنك تعديل النتائج يدويًا.</p>
      <textarea id="rawInput" placeholder="الصق وصفًا تفصيليًا هنا..."></textarea>
      <div class="chips">
        <span class="chip" id="wordInfo">0 كلمة</span>
        <span class="chip" id="aiMode">وضع: تلقائي محلي</span>
      </div>
      <div id="aiBanner" class="banner ok" hidden>تم تفعيل الذكاء الاصطناعي عبر API.</div>
      <div id="aiWarn" class="banner warn" hidden>تعذّر التوليد عبر API. تم استخدام الوضع المحلي الاحتياطي.</div>
    </section>

    <!-- ===== الحقول ===== -->
    <section class="card fields" id="sec-fields" aria-labelledby="formTitle">
      <h2 id="formTitle" class="sr-only">نموذج إدخال النصوص</h2>

      <div class="field">
        <div class="label">
          <label for="titleInput">العنوان (Title)</label>
          <div class="meters">
            <span class="meter-pill" id="titleCount" aria-live="polite">0 حرف</span>
            <span class="state" id="titleState">—</span>
            <button id="btnTrimTitle" class="nav-btn" style="padding:6px 10px">قص ≤60</button>
          </div>
        </div>
        <input id="titleInput" type="text" aria-label="حقل العنوان" placeholder="أدخل عنوان صفحتك هنا (≤ 60 حرف)">
        <div class="note">نمنع الرموز والإيموجي تلقائيًا عند القص.</div>
      </div>

      <div class="field">
        <div class="label">
          <label for="descInput">الوصف (Meta description)</label>
          <div class="meters">
            <span class="meter-pill" id="descCount" aria-live="polite">0 حرف</span>
            <span class="state" id="descState">—</span>
            <button id="btnClampDesc" class="nav-btn" style="padding:6px 10px">قص 150–160</button>
          </div>
        </div>
        <textarea id="descInput" aria-label="حقل الوصف" placeholder="وصف مختصر وجذاب (150–160 حرفًا)."></textarea>
        <div class="note">يتم ضبطه بدقّة بين 150 و160 حرف عند الضغط على زر القص أو بعد التوليد.</div>
      </div>

      <div class="field">
        <div class="label">
          <label for="urlInput">الرابط (URL)</label>
          <div class="meters">
            <span class="meter-pill" id="urlCount" aria-live="polite">0 حرف</span>
            <span class="state" id="urlState">—</span>
          </div>
        </div>
        <input id="urlInput" type="text" aria-label="حقل الرابط" placeholder="https://yourdomain.com/مسار-الصفحة">
        <div class="note">يُقترح مسار محسّن تلقائيًا ويُعرض LTR.</div>
      </div>

      <div class="btns">
        <button class="primary" id="copyTitleBtn" title="نسخ العنوان">نسخ العنوان</button>
        <button class="primary" id="copyDescBtn" title="نسخ الوصف">نسخ الوصف</button>
        <button class="primary" id="copyPreviewBtn" title="نسخ المعاينة كنص">نسخ المعاينة كنص</button>
        <button id="clearBtn" title="مسح الحقول">مسح الحقول</button>
      </div>
    </section>

    <!-- ===== المعاينة ===== -->
    <section class="preview" id="sec-preview" aria-labelledby="prevTitle">
      <h2 id="prevTitle" class="sr-only">معاينة نتيجة جوجل</h2>
      <div class="serp" id="serp">
        <h3 class="title" id="pTitle">أداة محاكاة مجانية لنتائج بحث جوجل (SERP) من أنس راشد</h3>
        <p class="url"><span dir="ltr" id="pUrl">yourdomain.com/أداة-محاكاة-مجانية-لنتائج-بحث-جوجل-serp-من-أنس-راشد</span></p>
        <p class="desc" id="pDesc">أنا أنس راشد مختص تحسين محركات البحث، أساعدك في تحقيق زيارات لمتجر من محركات البحث، وصممت هذه الاداة لتساعدك على كتابة عنوان ووصف ورابط مثالي لمنتجك أو مقالتك.</p>
      </div>
      <div class="foot-help">• حدود إرشادية: العنوان ≤ 60 — الوصف 150–160 حرف. • عرض البطاقة الحالي: <span id="limitsText">—</span></div>
    </section>
  </div>
</div>

<script>
/* ========== إعداد الذكاء الاصطناعي ========= */
const AI_CONFIG = {
  enabled: true,
  baseUrl: "https://seo-generate.anasshopify88.workers.dev", // ضع رابط الـWorker
  model: "@cf/meta/llama-3.1-8b-instruct",
  timeoutMs: 25000
};

/* === قياس بالبكسل عبر Canvas === */
(function(){ const c=document.createElement('canvas'),x=c.getContext('2d'); window.measurePx=(t,f)=>{x.font=f; return x.measureText(t==null?'':String(t)).width}; })();

const FONTS = {
  title:'800 22px Arial, Helvetica, sans-serif',
  desc :'normal 15px Arial, Helvetica, sans-serif',
  url  :'normal 14px Arial, Helvetica, sans-serif'
};
const ELLIPSIS='…', TITLE_CHAR_LIMIT=60, DESC_MIN=150, DESC_MAX=160;

const $=s=>document.querySelector(s);
const titleInput=$('#titleInput'), descInput=$('#descInput'), urlInput=$('#urlInput');
const pTitle=$('#pTitle'), pUrl=$('#pUrl'), pDesc=$('#pDesc'), serp=$('#serp');
const darkBtn=$('#darkBtn'), aiBanner=$('#aiBanner'), aiWarn=$('#aiWarn');
const titleCountEl=$('#titleCount'), titleState=$('#titleState');
const descCountEl=$('#descCount'), descState=$('#descState');
const urlCountEl=$('#urlCount'), urlState=$('#urlState');
const limitsText=$('#limitsText');
const copyTitleBtn=$('#copyTitleBtn'), copyDescBtn=$('#copyDescBtn'), copyPreviewBtn=$('#copyPreviewBtn');
const clearBtn=$('#clearBtn'), backBtn=$('#backBtn'), homeBtn=$('#homeBtn');
const btnTrimTitle=$('#btnTrimTitle'), btnClampDesc=$('#btnClampDesc');
const toolNameEl=document.querySelector('.tool-name');

const rawInput=$('#rawInput'), generateBtn=$('#generateBtn'), clearAllBtn=$('#clearAllBtn');
const wordInfo=$('#wordInfo'), aiMode=$('#aiMode');

let state={dark:false, title:'', desc:'', url:'', raw:''};
const STORAGE_KEY='serp_ai_preview_state_v2';
let urlAutoMode = true;

/* ========= Utils ========= */
const charCount = s => Array.from(String(s||'')).length;
const wordCount = s => (String(s||'').trim().match(/[\p{L}\p{N}’']+/gu)||[]).length;
const normalizeWS = s => String(s||'').replace(/\s+/g,' ').trim();

function stripSymbols(str){
  // حروف عربية/لاتينية/أرقام ومسافة وشرطتين فقط
  return Array.from(str||'').filter(ch=>/[0-9A-Za-z\u0600-\u06FF \-]/.test(ch)).join('').replace(/\s+/g,' ').trim();
}
function truncateByChars(text, limit){
  const arr = Array.from(text||''); if (arr.length<=limit) return text||'';
  const sliced = arr.slice(0, limit).join(''); const lastSpace = sliced.lastIndexOf(' ');
  const base = lastSpace>0 ? sliced.slice(0,lastSpace) : sliced;
  return base + ELLIPSIS;
}
function cleanUrlForDisplay(raw){
  if (!raw) return ''; return String(raw).trim().replace(/^https?:\/\//i,'').replace(/^www\./i,'');
}
function midTruncateToFit(str, limitPx, font){
  if (measurePx(str,font)<=limitPx) return str;
  let start=0,end=str.length-1, out=str;
  while (start<end){
    out = str.slice(0,start)+ELLIPSIS+str.slice(end+1);
    if (measurePx(out,font)<=limitPx) return out;
    (start <= (str.length-1-end)) ? start++ : end--;
  }
  let base=''; for (let i=0;i<str.length;i++){ const c=base+str[i]; if (measurePx(c+ELLIPSIS,font)<=limitPx) base=c; else break; }
  return base+ELLIPSIS;
}
function slugFromTitle(t){
  const keep = /[0-9A-Za-z\u0600-\u06FF\- ]/;
  let s = Array.from(t||'').filter(ch=>keep.test(ch)).join('');
  s = s.replace(/\s+/g,'-').replace(/\-+/g,'-').replace(/^\-|\-$/g,'');
  return s.toLowerCase();
}
function extractDomain(raw){
  if(!raw) return 'yourdomain.com';
  let s = raw.trim().replace(/^https?:\/\//i,'').replace(/^www\./i,'');
  s = s.split('/')[0].replace(/\/+$/,'');
  return s || 'yourdomain.com';
}
function composeUrl(domainPart, pathPart){
  const d = extractDomain(domainPart);
  return 'https://' + d + (pathPart?'/'+pathPart:'');
}
function availableWidth(el){ const r=el.getBoundingClientRect(); return Math.max(60, Math.floor(r.width)); }
function updateLimitsText(){ limitsText.textContent = `${availableWidth(serp)}px`; }

/* ========= توليد محلي صارم ========= */
const AR_STOP = new Set(['و','في','من','على','إلى','عن','أن','إن','كان','كانت','هذا','هذه','ذلك','تلك','هو','هي','هم','ثم','تم','قد','أو','كما','لكن','لأن','مع','لقد','لك','لكي','أي','كل','ما','لم','لن','إنه','إنها','هناك','هنا','بين','حتى','بعد','قبل','ذات','غير','بدون','حول','داخل','خلال','أكثر','أقل','حسب','إذا','أحد','أثناء','ضمن','عند','إلا','بل']);
function tokenize(text){ return (text||'').toLowerCase().match(/[\p{L}\p{N}]+/gu)||[]; }
function topKeywords(text, max=6){
  const freq = new Map(); for (const tok of tokenize(text)){ if (tok.length<3 || AR_STOP.has(tok)) continue; freq.set(tok,(freq.get(tok)||0)+1); }
  return [...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,max).map(x=>x[0]);
}
function makeTitleStrict(raw){
  let base = stripSymbols(raw||'');
  if (!base){
    const kws = topKeywords(raw,5);
    base = kws.slice(0,3).join(' ');
  }
  base = base.replace(/[|•·,،]+/g,' ').replace(/\s+/g,' ').trim();
  if (charCount(base) > TITLE_CHAR_LIMIT) base = truncateByChars(base, TITLE_CHAR_LIMIT);
  return base;
}
function clampMetaStrict(raw, contextText){
  let t = normalizeWS(raw||'');
  // لو طويلة جدًا: قص ذكي عند أقرب مسافة ≤160، مع …
  if (charCount(t) > DESC_MAX){
    const cut = t.lastIndexOf(' ', DESC_MAX);
    t = (cut>DESC_MIN? t.slice(0,cut) : t.slice(0,DESC_MAX)) + ELLIPSIS;
  }
  // لو أقصر من 150: زد وصفًا محايدًا بكلمات مفتاحية
  if (charCount(t) < DESC_MIN){
    const need = DESC_MIN - charCount(t);
    const kws = topKeywords(contextText||raw,6).join('، ');
    const addon = (kws? (' — ' + kws) : '');
    t = normalizeWS((t + addon).slice(0, DESC_MAX));
    // تأكد ضمن النطاق
    if (charCount(t) < DESC_MIN){
      const pad = ' — تفاصيل مهمة ومعلومات موجزة.';
      t = normalizeWS((t + pad).slice(0, DESC_MAX));
      if (charCount(t) < DESC_MIN) {
        // لو ما وصلنا، كرر كلمات قصيرة آمنة
        t = (t + ' — مزايا أساسية.').slice(0, DESC_MAX);
      }
    }
    if (charCount(t) > DESC_MAX){
      const cut2 = t.lastIndexOf(' ', DESC_MAX);
      t = (cut2>DESC_MIN? t.slice(0,cut2) : t.slice(0,DESC_MAX));
    }
  }
  return t;
}
function makeSlugFromText(text){
  const kws = topKeywords(text,6);
  const body = (kws.length ? kws : tokenize(text).slice(0,6)).join('-');
  return slugFromTitle(body || 'صفحة-جديدة');
}

/* ========= استدعاء الوِركر ========= */
async function aiGenerate(raw){
  const payload = {
    model: AI_CONFIG.model,
    text: raw,          // خلي الوِركر يبني الرسائل بنفسه
    temperature: 0.3
  };
  const controller = new AbortController();
  const timeout = setTimeout(()=>controller.abort(), AI_CONFIG.timeoutMs);
  let respText = "";
  try{
    const resp = await fetch(AI_CONFIG.baseUrl, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload),
      mode:'cors',
      cache:'no-store',
      signal: controller.signal
    });
    clearTimeout(timeout);
    respText = await resp.text();
    if (!resp.ok){
      console.warn('AI provider error:', resp.status, respText);
      throw new Error(`AI ${resp.status}`);
    }
    const data = JSON.parse(respText);
    return data; // {title, meta, slug}
  }catch(err){
    clearTimeout(timeout);
    console.warn("AI error:", err.message, respText.slice(0,300));
    throw err;
  }
}

/* ========= العرض ========= */
function fitOneLine(el, minPx=12, maxPx=24){
  if(!el) return;
  let size = parseFloat(getComputedStyle(el).fontSize) || maxPx;
  size = Math.max(Math.min(size, maxPx), minPx);
  el.style.whiteSpace = 'nowrap'; el.style.fontSize = size + 'px'; el.style.fontWeight = '800';
  let guard=0; while (el.scrollWidth > el.clientWidth && size > minPx && guard++ < 40){ size -= 1; el.style.fontSize = size + 'px'; }
  if (el.scrollWidth > el.clientWidth && size <= minPx){ el.style.fontWeight = '700'; }
}

function render(){
  const titleRaw = normalizeWS(titleInput.value).trimStart();
  const enforcedTitle = (charCount(titleRaw) > TITLE_CHAR_LIMIT) ? truncateByChars(titleRaw, TITLE_CHAR_LIMIT) : titleRaw;
  const tCount = charCount(titleRaw);
  titleCountEl.textContent = `${tCount} حرف`;
  titleState.textContent = (tCount>60)?'طويل':(tCount<30?'قصير':'مناسب');
  titleState.className = 'state ' + ((tCount>60)?'bad':(tCount<30?'warn':'ok'));
  pTitle.textContent = enforcedTitle || 'أداة محاكاة مجانية لنتائج بحث جوجل (SERP) من أنس راشد';

  if (urlAutoMode){
    const dom = extractDomain(urlInput.value || 'yourdomain.com');
    const slug = slugFromTitle(enforcedTitle || 'أداة-محاكاة-نتائج-بحث-جوجل');
    urlInput.value = composeUrl(dom, slug);
  }
  const urlLimit = availableWidth(pUrl.parentElement);
  pUrl.textContent = midTruncateToFit(cleanUrlForDisplay(urlInput.value || 'yourdomain.com/slug'), urlLimit, FONTS.url);
  urlCountEl.textContent = `${charCount(urlInput.value)} حرف`;
  urlState.textContent = '—'; urlState.className='state';

  const descRaw = descInput.value || '';
  let descClamped = descRaw;
  const dCount = charCount(descRaw);
  descCountEl.textContent = `${dCount} حرف`;
  descState.textContent = (dCount>160)?'طويل':(dCount<150?'قصير':'مناسب');
  descState.className = 'state ' + ((dCount>160)?'bad':(dCount<150?'warn':'ok'));

  const dRes = (()=>{
    const linePx = availableWidth(pDesc);
    // قص بالأسطر لعرض المعاينة فقط
    const tokens = String(descClamped).replace(/\n+/g,' ').split(/(\s+)/);
    let lines=['','']; let iLine=0;
    const fits=(curr,tok)=>measurePx(curr+tok, FONTS.desc)<=linePx;
    for (const tok of tokens){
      if (fits(lines[iLine], tok)){ lines[iLine]+=tok; }
      else {
        iLine++;
        if (iLine>1){
          let second = lines[1].trimEnd();
          while (second && measurePx(second+ELLIPSIS,FONTS.desc)>linePx){ second = second.replace(/\s*\S+$/,''); }
          return {lines:[lines[0], second+(second?ELLIPSIS:'')]};
        } else {
          if (measurePx(tok,FONTS.desc)<=linePx){ lines[iLine]=tok.replace(/^\s+/,''); }
          else { let piece=''; for (let j=0;j<tok.length;j++){ const c=piece+tok[j]; if (measurePx(c,FONTS.desc)<=linePx) piece=c; else break; } lines[iLine]=piece; }
        }
      }
    }
    return {lines, clipped:false};
  })();
  pDesc.textContent = (dRes.lines[0] + (dRes.lines[1]? '\n'+dRes.lines[1] : '')).trim();

  updateLimitsText();
}

/* ========= نسخ ========= */
async function copyText(s){
  try{
    if (navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(s); }
    else { const ta=document.createElement('textarea'); ta.value=s; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); }
  }catch(e){}
}

/* ========= Debounce ========= */
function debounce(fn,ms=150){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args),ms);} }
const onInput = debounce(()=>{ render(); saveState(); },150);

/* ========= حالة وتخزين ========= */
function saveState(){
  state.title=titleInput.value||''; state.desc=descInput.value||''; state.url=urlInput.value||'';
  state.raw=rawInput.value||'';
  try{localStorage.setItem(STORAGE_KEY, JSON.stringify(state));}catch(e){}
}
function loadState(){
  try{ const raw=localStorage.getItem(STORAGE_KEY); if(raw){ state=Object.assign(state, JSON.parse(raw)||{}); } }catch(e){}
}

/* ========= أزرار القص الفوري ========= */
btnTrimTitle.addEventListener('click', ()=>{
  titleInput.value = makeTitleStrict(titleInput.value);
  render(); saveState();
});
btnClampDesc.addEventListener('click', ()=>{
  descInput.value = clampMetaStrict(descInput.value, rawInput.value);
  render(); saveState();
});

/* ========= توليد من الوصف ========= */
async function generateFromRaw(){
  let raw = rawInput.value || '';
  const wc = wordCount(raw);
  if (wc > 3000){
    const tokens = raw.split(/\s+/);
    raw = tokens.slice(0,3000).join(' ');
    rawInput.value = raw;
  }

  aiWarn.hidden = true;
  generateBtn.classList.add('loading'); generateBtn.textContent='... جاري التوليد';

  try{
    let out=null;
    if (AI_CONFIG.enabled && AI_CONFIG.baseUrl){
      out = await aiGenerate(raw);
      aiMode.textContent = 'وضع: ذكاء اصطناعي (API)';
      aiBanner.hidden = false;
    }
    if (!out) throw new Error('no_api');

    // قص صارم على نتائج الـAPI
    titleInput.value = makeTitleStrict(out.title||'');
    descInput.value  = clampMetaStrict(out.meta||'', raw);
    const currentDomain = extractDomain(urlInput.value || 'yourdomain.com');
    urlInput.value   = composeUrl(currentDomain, slugFromTitle((out.slug||'').trim() || makeSlugFromText(raw)));
    urlAutoMode = false;
    render(); saveState();
  }catch(err){
    // احتياطي محلي بدون alert
    aiWarn.hidden = false; aiBanner.hidden = true; aiMode.textContent = 'وضع: تلقائي محلي';
    const out = {
      title: makeTitleStrict(raw),
      meta:  clampMetaStrict(raw, raw),
      slug:  makeSlugFromText(raw)
    };
    titleInput.value = out.title;
    descInput.value  = out.meta;
    const currentDomain = extractDomain(urlInput.value || 'yourdomain.com');
    urlInput.value   = composeUrl(currentDomain, out.slug);
    urlAutoMode = false; render(); saveState();
    console.warn('Fallback local mode used.', err?.message||err);
  }finally{
    generateBtn.classList.remove('loading'); generateBtn.textContent='توليد';
  }
}

/* ========= تهيئة ========= */
(function init(){
  loadState();

  const defTitle='أداة محاكاة مجانية لنتائج بحث جوجل (SERP) من أنس راشد';
  const defDesc='أنا أنس راشد مختص تحسين محركات البحث، أساعدك في تحقيق زيارات لمتجر من محركات البحث، وصممت هذه الاداة لتساعدك على كتابة عنوان ووصف ورابط مثالي لمنتجك أو مقالتك.';
  titleInput.value = state.title || defTitle;
  descInput.value  = state.desc  || defDesc;
  urlInput.value   = state.url   || ('https://yourdomain.com/'+slugFromTitle(defTitle));
  rawInput.value   = state.raw   || '';

  wordInfo.textContent = `${wordCount(rawInput.value)} كلمة`;
  aiMode.textContent = (AI_CONFIG.enabled && AI_CONFIG.baseUrl) ? 'وضع: ذكاء اصطناعي (API)' : 'وضع: تلقائي محلي';
  aiBanner.hidden = !(AI_CONFIG.enabled && AI_CONFIG.baseUrl);

  render();

  rawInput.addEventListener('input', ()=>{ wordInfo.textContent = `${wordCount(rawInput.value)} كلمة`; saveState(); });
  titleInput.addEventListener('input', ()=>{ urlAutoMode = true; onInput(); });
  descInput .addEventListener('input', onInput);
  urlInput  .addEventListener('input', ()=>{ urlAutoMode = false; onInput(); });

  // زر "توليد" + اختصار
  generateBtn.addEventListener('click', ()=>{
    if (!rawInput.value.trim()){
      rawInput.value = [titleInput.value, descInput.value, urlInput.value].filter(Boolean).join('\n');
      wordInfo.textContent = `${wordCount(rawInput.value)} كلمة`;
    }
    generateFromRaw();
  });
  rawInput.addEventListener('keydown', (e)=>{
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); generateBtn.click(); }
  });

  backBtn.addEventListener('click', ()=>history.back());
  homeBtn.addEventListener('click', ()=>location.href = '/');

  window.addEventListener('resize', debounce(()=>{ render(); fitOneLine(toolNameEl,12,24); }, 150));
  window.addEventListener('orientationchange', ()=>{ setTimeout(()=>{ render(); fitOneLine(toolNameEl,12,24); }, 150); });
  const ro = new ResizeObserver(()=>{ render(); fitOneLine(toolNameEl,12,24); });
  [document.querySelector('.brand'), toolNameEl, serp, pUrl.parentElement, pDesc].forEach(el=> ro.observe(el));

  const darkOn = document.body.classList.contains('dark');
  darkBtn.setAttribute('aria-pressed', darkOn);
  darkBtn.addEventListener('click', ()=>{
    document.body.classList.toggle('dark');
    const on=document.body.classList.contains('dark');
    darkBtn.setAttribute('aria-pressed', on);
    darkBtn.textContent = on ? 'الوضع الفاتح' : 'الوضع الداكن';
    saveState();
  });

  copyTitleBtn.addEventListener('click', ()=>copyText(titleInput.value));
  copyDescBtn .addEventListener('click', ()=>copyText(descInput.value));
  copyPreviewBtn.addEventListener('click', ()=>copyText([titleInput.value, cleanUrlForDisplay(urlInput.value), descInput.value].filter(Boolean).join('\n')));

  clearBtn.addEventListener('click', ()=>{ titleInput.value=''; descInput.value=''; urlInput.value=''; urlAutoMode=true; render(); saveState(); });
  clearAllBtn.addEventListener('click', ()=>{ rawInput.value=''; wordInfo.textContent='0 كلمة'; saveState(); });

  fitOneLine(toolNameEl,12,24);
})();
</script>
</body>
</html>
