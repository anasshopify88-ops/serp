<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>أداة محاكاة مجانية لنتائج جوجل من أنس راشد</title>
<style>
  :root{
    --bg:#f6f8fb; --text:#0f172a; --muted:#6b7280; --card:#ffffff; --border:#e5e7eb;
    --primary:#2563eb; --g-blue:#1a0dab; --g-url:#3c4043; --g-desc:#4d5156;
    --shadow:0 10px 30px rgba(2,8,23,.08); --radius:18px;
    --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
  }
  .dark{
    --bg:#0b1220; --text:#e5e7eb; --muted:#9aa4b2; --card:#0f172a; --border:#1f2a44;
    --g-blue:#8ab4f8; --g-url:#bdc1c6; --g-desc:#bdc1c6; --shadow:0 10px 30px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  html,body{height:100%; overflow-x:hidden; width:100%; max-width:100%; -webkit-text-size-adjust:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.65 Arial, Helvetica, sans-serif}
  @media (min-width:1280px){ body{font-size:16px} }
  img{max-width:100%; height:auto}
  .wrap{max-width:1200px;margin:24px auto;padding:0 12px 40px;width:100%}
  @media (max-width:480px){ .wrap{padding:0 10px 28px} }
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

  header{display:flex;align-items:center;justify-content:space-between;gap:14px;margin-bottom:14px;flex-wrap:wrap}
  .brand{display:flex;align-items:center;gap:12px}
  .avatar{
    width:72px;height:72px;border-radius:50%;object-fit:cover;background:#fff;
    border:1px solid var(--border);box-shadow:var(--shadow)
  }
  .tool-name{font-weight:800;font-size:clamp(18px,2.2vw,28px);line-height:1.2;white-space:nowrap}
  @media (max-width:700px){
    header{flex-direction:column;align-items:center;gap:10px}
    .brand{flex-direction:column;align-items:center;text-align:center}
    .avatar{width:104px;height:104px}
    .tool-name{font-size:clamp(16px,5vw,22px);max-width:92vw;white-space:nowrap}
    .header-actions{width:100%;justify-content:center;min-width:0}
  }
  .header-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .toggle,.nav-btn{padding:10px 14px;border:1px solid var(--border);border-radius:999px;background:var(--card);cursor:pointer}
  .nav-btn.home{background:#000;color:#fff;border-color:#000}
  .nav-btn:focus,.toggle:focus{outline:2px solid var(--primary);outline-offset:2px}

  /* ===== التخطيط ===== */
  .row{
    display:grid; gap:20px; align-items:start;
    grid-template-columns: minmax(0,1.1fr) minmax(0,0.9fr);
    grid-template-areas:
      "ai preview"
      "fields preview";
  }
  #sec-ai{grid-area:ai}
  #sec-fields{grid-area:fields}
  #sec-preview{grid-area:preview}
  @media (max-width:1024px){
    .row{grid-template-columns:1fr;grid-template-areas:"ai" "fields" "preview";gap:14px}
  }

  .card,.preview{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card{padding:16px}
  .preview{padding:16px; position:sticky; top:16px; align-self:start}

  .ai-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
  .ai-actions{display:flex;gap:8px;flex-wrap:wrap}
  .hint{font-size:12px;color:var(--muted)}
  .banner{font-size:12px;margin-top:8px;display:flex;align-items:center;gap:8px}
  .banner.ok{color:var(--ok)} .banner.warn{color:var(--warn)} .banner.bad{color:var(--bad)}
  textarea#rawInput{
    width:100%;max-width:100%;min-height:160px;max-height:48vh;resize:vertical;
    padding:14px;border:1px solid var(--border);border-radius:14px;background:#fff0;color:var(--text);
    overflow:auto;-webkit-overflow-scrolling:touch;
  }
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#fff0;font-size:12px}

  .fields .field{margin-bottom:14px}
  .label{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px;font-weight:700;font-size:14px}
  input[type="text"], textarea:not(#rawInput){
    width:100%;max-width:100%;padding:14px;border:1px solid var(--border);border-radius:14px;background:#fff0;color:var(--text);outline:none;
  }
  textarea:not(#rawInput){min-height:110px;max-height:40vh;resize:vertical}
  .note{font-size:12px;color:var(--muted)}
  .meters{display:flex;align-items:center;gap:8px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
  .meter-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff0;font-weight:700}
  .state{font-weight:800}.ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
  .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
  button{padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#fff0;color:var(--text);cursor:pointer}
  button.primary{background:var(--primary);border-color:var(--primary);color:#fff}
  button:focus{outline:2px solid var(--primary);outline-offset:2px}
  .loading{opacity:.7;pointer-events:none}

  .serp{display:flex;flex-direction:column;gap:3px;width:100%; overflow-wrap:anywhere;word-break:break-word}
  .serp .title{
    font:800 clamp(18px,2.2vw,22px)/1.3 Arial, Helvetica, sans-serif;color:var(--g-blue);margin:0;
    width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  }
  .serp .url{
    color:var(--g-url);font:normal 14px/1.7 Arial, Helvetica, sans-serif;margin:0 0 2px;
    width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  }
  .serp .desc{
    color:var(--g-desc);font:normal 15px/1.4 Arial, Helvetica, sans-serif;margin:0;
    width:100%;white-space:pre-line;
  }
  .foot-help{margin-top:10px;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap" id="app">
  <header>
    <div class="brand">
      <img id="avatar" class="avatar" alt="صورة أنس راشد" src="https://i.imgur.com/B3UkEQ0.jpg">
      <div class="tool-name">أداة محاكاة مجانية لنتائج جوجل من أنس راشد</div>
    </div>
    <div class="header-actions" role="group" aria-label="خيارات التنقل">
      <button id="backBtn" class="nav-btn" title="رجوع">رجوع</button>
      <button id="homeBtn" class="nav-btn home" title="الرئيسية">الرئيسية</button>
      <button id="darkBtn" class="toggle" aria-pressed="false" aria-label="تبديل الوضع الداكن">الوضع الداكن</button>
    </div>
  </header>

  <div class="row">
    <!-- ===== AI ===== -->
    <section class="card" id="sec-ai" aria-labelledby="aiTitle">
      <div class="ai-head">
        <h2 id="aiTitle" style="margin:0;font-size:16px">إنشاء العنوان والوصف والرابط تلقائيًا</h2>
        <div class="ai-actions">
          <button id="generateBtn" class="primary">توليد</button>
          <button id="clearAllBtn">مسح الكل</button>
        </div>
      </div>
      <p class="hint">الصق وصف المنتج/الخدمة/المقال (حتى 3000 كلمة). بعد التوليد يمكنك تعديل النتائج يدويًا.</p>
      <textarea id="rawInput" placeholder="الصق وصفًا تفصيليًا هنا..."></textarea>
      <div class="chips">
        <span class="chip" id="wordInfo">0 كلمة</span>
        <span class="chip" id="aiMode">وضع: —</span>
      </div>
      <div id="aiBanner" class="banner ok" hidden>تم استخدام الذكاء الاصطناعي عبر API.</div>
      <div id="aiWarn" class="banner warn" hidden>تعذّر استخدام API — تم الاعتماد على المولّد المحلي.</div>
    </section>

    <!-- ===== الحقول ===== -->
    <section class="card fields" id="sec-fields" aria-labelledby="formTitle">
      <h2 id="formTitle" class="sr-only">نموذج إدخال النصوص</h2>

      <div class="field">
        <div class="label">
          <label for="titleInput">العنوان (Title)</label>
          <div class="meters">
            <span class="meter-pill" id="titleCount" aria-live="polite">0 حرف</span>
            <span class="state" id="titleState">—</span>
            <button id="btnTrimTitle" class="nav-btn" style="padding:6px 10px">قص ≤60</button>
          </div>
        </div>
        <input id="titleInput" type="text" aria-label="حقل العنوان" placeholder="أدخل عنوان صفحتك هنا (≤ 60 حرف)">
        <div class="note">نمنع الرموز والإيموجي تلقائيًا عند القص.</div>
      </div>

      <div class="field">
        <div class="label">
          <label for="descInput">الوصف (Meta description)</label>
          <div class="meters">
            <span class="meter-pill" id="descCount" aria-live="polite">0 حرف</span>
            <span class="state" id="descState">—</span>
            <button id="btnClampDesc" class="nav-btn" style="padding:6px 10px">قص 150–160</button>
          </div>
        </div>
        <textarea id="descInput" aria-label="حقل الوصف" placeholder="وصف مختصر وجذاب (150–160 حرفًا)."></textarea>
        <div class="note">يُضبط بدقّة بين 150 و160 حرفًا (قص ذكي على حدود الكلمات).</div>
      </div>

      <div class="field">
        <div class="label">
          <label for="urlInput">الرابط (URL)</label>
          <div class="meters">
            <span class="meter-pill" id="urlCount" aria-live="polite">0 حرف</span>
            <span class="state" id="urlState">—</span>
          </div>
        </div>
        <input id="urlInput" type="text" aria-label="حقل الرابط" placeholder="https://yourdomain.com/مسار-الصفحة">
        <div class="note">يُقترح مسار محسّن تلقائيًا ويُعرض LTR.</div>
      </div>

      <div class="btns">
        <button class="primary" id="copyTitleBtn" title="نسخ العنوان">نسخ العنوان</button>
        <button class="primary" id="copyDescBtn" title="نسخ الوصف">نسخ الوصف</button>
        <button class="primary" id="copyPreviewBtn" title="نسخ المعاينة كنص">نسخ المعاينة كنص</button>
        <button id="clearBtn" title="مسح الحقول">مسح الحقول</button>
      </div>
    </section>

    <!-- ===== المعاينة ===== -->
    <section class="preview" id="sec-preview" aria-labelledby="prevTitle">
      <h2 id="prevTitle" class="sr-only">معاينة نتيجة جوجل</h2>
      <div class="serp" id="serp">
        <h3 class="title" id="pTitle">أداة محاكاة مجانية لنتائج بحث جوجل (SERP) من أنس راشد</h3>
        <p class="url"><span dir="ltr" id="pUrl">yourdomain.com/أداة-محاكاة-مجانية-لنتائج-بحث-جوجل-serp-من-أنس-راشد</span></p>
        <p class="desc" id="pDesc">أنا أنس راشد مختص تحسين محركات البحث، أساعدك في تحقيق زيارات لمتجر من محركات البحث، وصممت هذه الاداة لتساعدك على كتابة عنوان ووصف ورابط مثالي لمنتجك أو مقالتك.</p>
      </div>
      <div class="foot-help">• حدود إرشادية: العنوان ≤ 60 — الوصف 150–160 حرف. • عرض البطاقة الحالي: <span id="limitsText">—</span></div>
    </section>
  </div>
</div>

<script>
/* ===== [A] إصلاح الشارات: حالة واحدة فقط ===== */
function setStatus(mode){
  // أوقف كل شيء أولاً
  aiBanner.hidden = true;
  aiWarn.hidden = true;
  if (mode === 'api'){
    aiMode.textContent = 'وضع: ذكاء اصطناعي (API)';
    aiBanner.hidden = false;
  } else if (mode === 'local'){
    aiMode.textContent = 'وضع: تلقائي محلي';
    aiWarn.hidden = false;
  } else {
    aiMode.textContent = 'وضع: —';
  }
}

/* ===== [B] مولّد محلي ذكي للمنتجات (من النص نفسه) ===== */
// مساعدات
function extractBrandModel(text){
  // يلقط تسلسلات لاتينية/أرقام (مثال: "Anker Life Q30" أو "WH-1000XM5")
  const latinSeq = [...String(text).matchAll(/[A-Za-z]+(?:\s+[A-Za-z0-9+\-_.]+){0,3}/g)]
                    .map(m=>m[0]).filter(s=>s.length<=36);
  // يلقط تسلسلات عربية قصيرة للعلامات/الموديل
  const arabSeq  = [...String(text).matchAll(/[\u0600-\u06FF]{3,}(?:\s+[\u0600-\u06FF0-9\-]{2,}){0,2}/g)]
                    .map(m=>m[0]);
  const bad = /^(tech|official|product|generic|سماعات|هاتف|متجر|جهاز|شركة|علامة|موديل)$/i;
  const pick = [...latinSeq, ...arabSeq].find(s=>!bad.test(s.trim()));
  return pick ? stripSymbols(pick) : '';
}
const FEATURE_MAP = [
  {re:/(anc|إلغاء|عزل)\s*(ال)?ضوضاء|noise\s*cancell/i, p:'عزل ضوضاء'},
  {re:/bluetooth\s*5(?:\.\d)?|بلوتوث/i, p:'Bluetooth 5'},
  {re:/(?:(\d+)\s*ساعة)|بطارية|mAh/i, p:(m)=> m && m[1] ? `بطارية حتى ${m[1]} ساعة` : 'بطارية طويلة'},
  {re:/case|علبة|شحن/i, p:'علبة شحن'},
  {re:/ميكروفون|مكالمات|mic|call/i, p:'مايك للمكالمات'},
  {re:/ماء|ip(?:5|6)\w*/i, p:'مقاومة ماء'},
  {re:/خفيف|راحة|وسائد|pads/i, p:'مريحة وخفيفة'}
];
function pickFeatures(text, max=3){
  const res=[];
  for (const rule of FEATURE_MAP){
    const m = String(text).match(rule.re);
    if (m){
      res.push(typeof rule.p==='function' ? rule.p(m) : rule.p);
      if (res.length>=max) break;
    }
  }
  if (res.length<max){
    for (const k of topKeywords(text, 10)){
      if (k.length>3 && !res.some(x=>x.includes(k))) res.push(k);
      if (res.length>=max) break;
    }
  }
  return res.slice(0,max);
}
function localFromText(raw){
  const kind = (typeof detectType==='function') ? detectType(raw) : 'generic';
  if (kind==='product'){
    const bm = extractBrandModel(raw);       // Brand/Model
    const feats = pickFeatures(raw, 3);      // 2-3 مزايا
    // العنوان
    let title = (bm? bm+' - ' : '') + (feats[0] || 'مواصفات مميزة');
    title = stripSymbols(title);
    if (charCount(title)>60) title = truncateByChars(title, 60);
    // الوصف (150–160)
    let meta = `سماعات ${bm||''} تمنحك ${feats[0]||'أداءً ثابتًا'}، مع ${feats[1]||'جودة صوت'} و${feats[2]||'راحة في الارتداء'}. اختيار مناسب للموسيقى والمكالمات يوميًا.`;
    meta = clampMetaStrict(meta, raw);
    // المسار
    const slug = slugFromTitle(`${bm?bm+' ':''}${(feats.join(' ')).trim()}`);
    return {title, meta, slug};
  }
  // غير المنتج: استخدم مولّداتك الحالية
  if (typeof titleForService==='function' && kind==='service')  return { title:titleForService(raw),  meta:metaForService(raw),  slug:makeSlugFromText(raw) };
  if (typeof titleForArticle==='function' && kind==='article')  return { title:titleForArticle(raw),  meta:metaForArticle(raw),  slug:makeSlugFromText(raw) };
  return { title: titleForArticle ? titleForArticle(raw) : makeTitleStrict(raw),
           meta:  metaForArticle ? metaForArticle(raw)   : clampMetaStrict('', raw),
           slug:  makeSlugFromText(raw) };
}

/* ===== [C] شدّ براغي generateFromRaw: دايمًا نربط الناتج بالنص ===== */
(function patchGenerate(){
  if (typeof generateFromRaw !== 'function') return;
  const containsSalla = s=>/سلة|salla/i.test(String(s));
  const _old = generateFromRaw;
  generateFromRaw = async function(){
    let raw = rawInput.value || '';
    const wc = wordCount(raw);
    if (wc > 3000){
      const tokens = raw.split(/\s+/); raw = tokens.slice(0,3000).join(' '); rawInput.value = raw;
    }
    setStatus('idle');
    generateBtn.classList.add('loading'); generateBtn.textContent='... جاري التوليد';
    try{
      let out=null;
      if (AI_CONFIG.enabled && AI_CONFIG.baseUrl){
        out = await aiGenerate(raw);
        setStatus('api');
      }
      if (!out) throw new Error('no_api');

      let titleOut = makeTitleStrict(out.title||'');
      let metaOut  = clampMetaStrict(out.meta||'', raw);

      // لو النتيجة عامة جدًا أو رجعت ذكر "سلة" بدون وجودها في النص — استخدم المحلي الذكي
      if (!titleOut || charCount(titleOut)<15 || !metaOut || charCount(metaOut)<150 ||
          (containsSalla(titleOut+metaOut) && !containsSalla(raw))){
        const loc = localFromText(raw);
        titleOut = loc.title; metaOut = loc.meta;
        out.slug = out.slug || loc.slug;
      }

      titleInput.value = titleOut;
      descInput.value  = metaOut;
      const currentDomain = extractDomain(urlInput.value || 'yourdomain.com');
      const suggestedSlug = (out.slug||'').trim() || localFromText(raw).slug;
      urlInput.value   = composeUrl(currentDomain, slugFromTitle(suggestedSlug));
      urlAutoMode = false;
      render(); saveState();
    }catch(err){
      setStatus('local');
      const loc = localFromText(raw);
      titleInput.value = loc.title;
      descInput.value  = loc.meta;
      const currentDomain = extractDomain(urlInput.value || 'yourdomain.com');
      urlInput.value   = composeUrl(currentDomain, loc.slug);
      urlAutoMode = false; render(); saveState();
      console.warn('Fallback local used.', err?.message||err);
    }finally{
      generateBtn.classList.remove('loading'); generateBtn.textContent='توليد';
    }
  };
})();
</script>
</body>
</html>
