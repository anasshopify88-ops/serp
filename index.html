<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover">
<title>أداة محاكاة مجانية لنتائج جوجل (SERP) بالذكاء الإصطناعي</title>

<!-- خط عربي -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">

<style>
  :root{
    /* ثيم موحّد */
    --bg:#f7f8fb; --bg-2:#f1f5fb; --card:#ffffff; --text:#0c1424; --muted:#5b6472; --accent:#2563eb;
    --ok:#15803d; --warn:#d97706; --error:#dc2626; --border:#e6e9f2; --shadow:0 6px 16px rgba(0,0,0,.08);
    --radius:16px; --radius-sm:12px;

    /* عمود جانبي */
    --sidebar-w:280px;

    /* أحجام */
    --fs-base:13px; --fs-sm:11.5px; --fs-xs:10.5px;

    /* ألوان SERP */
    --g-blue:#1a0dab; --g-url:#3c4043; --g-desc:#4d5156;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:"Cairo",system-ui,Arial,Helvetica,sans-serif; line-height:1.65;
    background:linear-gradient(180deg,var(--bg),var(--bg-2)); color:var(--text);
    -webkit-font-smoothing:antialiased; overflow-x:hidden; font-size:var(--fs-base);
  }

  .wrap{max-width:1200px;margin:0 auto;padding:24px 16px 64px}

  /* توب بار */
  .topbar{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap}
  .btn{
    border:1px solid var(--border); background:linear-gradient(180deg,#fff,#f9fbff);
    color:var(--text); padding:8px 12px; border-radius:14px; cursor:pointer; font-weight:700; box-shadow:var(--shadow);
    transition:transform .18s ease, box-shadow .25s ease, border-color .25s ease, background .25s ease;
    font-size:12px; text-decoration:none; display:inline-flex; align-items:center; gap:6px;
  }
  .btn:hover{transform:translateY(-2px); border-color:#cbd5e1}
  .btn.home{background:#000; color:#fff; border-color:#000}
  .btn:disabled{opacity:.6; cursor:not-allowed}

  /* زر تواصل معي في التوب بار */
  .btn.contactTop{
    background: var(--accent);
    border-color: var(--accent);
    color:#fff;
    justify-content:center;
  }
  .btn.contactTop:hover{
    background: var(--accent);
    border-color: var(--accent);
    color:#fff;
  }

  /* بطاقة عنوان */
  .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow)}
  .titleRow{display:flex;align-items:center;gap:10px;justify-content:space-between}
  h1{margin:0;font-size:clamp(18px,2.2vw,24px);font-weight:800;letter-spacing:.2px}
  .sub{margin-top:6px;color:var(--muted);font-size:var(--fs-sm)}
  .logo{width:100%; max-width:180px; align-self:center; object-fit:contain; object-position:center; background:#fff; border-radius:12px; border:1px solid var(--border); padding:8px}
  .title-logo{width:180px; max-width:180px; align-self:center}

  /* التخطيط العام */
  .layout{
    display:grid;
    grid-template-columns: var(--sidebar-w) 1fr;
    gap:14px;
    align-items:stretch;
  }

  /* السايدبار */
  #sidePanel{display:flex; height:100%; min-height:0; overflow:hidden;}
  @media (min-width:981px){ #sidePanel{ contain:size; } }
  .sidebar-card{
    flex:1 1 auto; height:100%;
    display:flex; flex-direction:column; gap:10px; min-height:0; overflow:auto;
  }
  .avatar{width:112px;height:112px;border-radius:50%;background:#fff;padding:6px;object-fit:contain;object-position:center;border:1px solid var(--border);align-self:center}
  .s-list{display:grid; gap:8px}
  .s-item a{
    display:block; padding:8px 10px; border:1px solid var(--border); border-radius:12px; background:#fff;
    color:#0f172a; text-decoration:none; font-weight:600; transition:transform .15s ease, box-shadow .2s ease, border-color .2s ease;
    box-shadow:0 4px 12px rgba(15,23,42,.05); font-size:13px;
  }
  .s-item a:hover{transform:translateY(-2px); border-color:#cbd5e1; box-shadow:0 8px 18px rgba(15,23,42,.08)}

  /* نص بدون رابط بنفس ستايل الروابط */
  .s-text{
    display:block; padding:8px 10px; border:1px solid var(--border); border-radius:12px; background:#fff;
    color:#0f172a; font-weight:600; box-shadow:0 4px 12px rgba(15,23,42,.05); font-size:13px;
  }

  /* يمين: الأداة */
  #toolBox{display:block; min-height:0}

  .row{
    display:grid; gap:16px; align-items:stretch;
    grid-template-columns: minmax(0,1.1fr) minmax(0,0.9fr);
    grid-template-rows: auto 1fr;
    grid-template-areas:
      "fields ai"
      "fields preview";
    min-width:0;
  }
  .row > *{min-width:0}
  @media (max-width:1024px){
    .row{ grid-template-columns:1fr; grid-template-rows:auto auto auto;
      grid-template-areas:"ai" "preview" "fields"; gap:12px; }
  }

  .card.section{padding:16px}
  .preview{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; margin:0; height:100%}
  @media (max-width:1024px){ .preview{height:auto} }

  .fields .field{margin-bottom:14px}
  .fields .field:last-child{ margin-bottom: 0 }
  .label{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px;font-weight:700;font-size:14px}
  input[type="text"], select, textarea:not(#rawInput){
    width:100%;padding:14px;border:1px solid var(--border);border-radius:14px;background:#fff;color:var(--text)
  }
  textarea:not(#rawInput){min-height:110px;max-height:40vh;resize:vertical}
  .switches{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
  .switches label{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:6px}
  .meters{display:flex;align-items:center;gap:8px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
  .meter-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;font-weight:700}

  .ai-actions{display:flex;gap:8px;flex-wrap:wrap}
  .ai-actions button{flex:1 1 0; min-width:140px}

  textarea#rawInput{
    width:100%;max-width:100%;min-height:160px;max-height:48vh;resize:vertical;
    padding:14px;border:1px solid var(--border);border-radius:14px;background:#fff;color:var(--text)
  }
  .chips{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:8px}
  .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:12px}

  .hint{font-size:12px;color:var(--muted)}
  .status{font-size:12px;margin-top:8px;display:flex;align-items:center;gap:8px}
  .status.ok{color:var(--ok)} .status.warn{color:var(--warn)} .status.bad{color:var(--error)} .status.hidden{display:none}
  .err{margin-top:8px;font-size:12px;color:var(--error)}

  .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
  button{padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#fff;color:var(--text);cursor:pointer}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  button.loading{opacity:.7;pointer-events:none}

  .serp{display:flex;flex-direction:column;gap:3px;width:100%; overflow-wrap:anywhere;word-break:break-word}
  .serp .title{font:800 clamp(18px,2.2vw,22px)/1.3 Cairo, Arial, Helvetica, sans-serif;color:var(--g-blue);margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .serp .title.full{white-space:normal;overflow:visible;text-overflow:clip}
  .serp .url{color:var(--g-url);font:normal 14px/1.7 Cairo, Arial, Helvetica, sans-serif;margin:0 0 2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .serp .desc{color:var(--g-desc);font:normal 15px/1.4 Cairo, Arial, Helvetica, sans-serif;margin:0;white-space:pre-line}
  @media (max-width:1024px){
    .serp .title, .serp .url{white-space:normal;overflow:visible;text-overflow:clip}
  }
  .foot-help{margin-top:10px;font-size:12px;color:var(--muted)}

  @media (max-width:980px){
    .layout{grid-template-columns:1fr}
    #sidePanel{height:auto; overflow:visible;}
    .avatar{width:104px;height:104px}
  }
</style>
</head>
<body>
  <div class="wrap" id="app">
    <!-- توب بار -->
    <div class="topbar">
      <button class="btn" id="backBtn">رجوع</button>
      <a class="btn home" id="homeBtn" href="https://anasrashed.com" rel="noopener">الرئيسية</a>

      <!-- ✅ تواصل معي بدل زر الوضع الداكن -->
      <a class="btn contactTop" id="contactTopBtn" href="https://contact.anasrashed.com" target="_blank" rel="noopener">تواصل معي</a>
    </div>

    <!-- عنوان الأداة -->
    <div class="card">
      <div class="titleRow">
        <div>
          <h1>أداة محاكاة مجانية لنتائج جوجل (SERP) بالذكاء الإصطناعي</h1>
          <div class="sub">اكتب/ولّد العنوان والوصف والرابط مع معاينة مماثلة لنتائج جوجل.</div>
        </div>
        <img class="logo title-logo" src="https://i.imgur.com/meUEoP7.png" alt="الشعار"
             onerror="this.onerror=null; this.src='https://i.imgur.com/meUEoP7.jpg';">
      </div>
    </div>

    <!-- التخطيط -->
    <div class="layout" style="margin-top:12px">
      <!-- السايدبار -->
      <aside id="sidePanel">
        <div class="card sidebar-card">
          <img class="avatar" src="https://i.imgur.com/B3UkEQ0.jpg" alt="صورتي" referrerpolicy="no-referrer"
               onerror="this.onerror=null; this.src='https://i.imgur.com/B3UkEQ0.png';">

          <div class="s-list">
            <div class="s-item"><a href="https://whoami.anasrashed.com" target="_blank" rel="noopener">من أنا؟</a></div>

            <div class="s-item">
              <a href="https://anasrashed.gumroad.com/l/seo-book-for-ecommerce" target="_blank" rel="noopener">
                كتاب دليل السيو الشامل
              </a>
            </div>

            <div class="sub" style="text-align:center; font-size:18px; margin-top:10px;">
              <b>خدماتي</b>
            </div>

            <!-- ✅ خدمات بدون روابط -->
            <div class="s-item"><span class="s-text">تحسين سيو المتجر</span></div>
            <div class="s-item"><span class="s-text">حملة باك لينك شهرية</span></div>
            <div class="s-item"><span class="s-text">استخراج الكلمات المفتاحية للمنافسين</span></div>
            <div class="s-item"><span class="s-text">تفعيل خريطة الموقع للباقة بلس</span></div>

            <div class="sub" style="text-align:center; font-size:18px; margin-top:10px;">
              <b>أدوات سيو احترافية</b>
            </div>

            <!-- ✅ الأدوات -->
            <div class="s-item"><a href="https://serp.anasrashed.com" target="_blank" rel="noopener">أداة SERP بالذكاء الإصطناعي</a></div>
            <div class="s-item"><a href="https://smg.anasrashed.com" target="_blank" rel="noopener">أداة منشئ خريطة الموقع</a></div>
            <div class="s-item"><a href="https://keywords.anasrashed.com" target="_blank" rel="noopener">أداة الكلمات المفتاحية</a></div>
            <div class="s-item"><a href="https://checker.anasrashed.com" target="_blank" rel="noopener">أداة فحص الموقع</a></div>

            <!-- ❌ تم حذف "تواصل معي" من السايدبار (صار بالتوب بار) -->
          </div>
        </div>
      </aside>

      <!-- الأداة -->
      <section id="toolBox">
        <div class="row">
          <section class="card section fields" id="sec-fields" style="grid-area:fields">
            <div class="switches">
              <label><input type="checkbox" id="autoPolish" checked> تلميع تلقائي بعد التوليد</label>
            </div>

            <div class="field">
              <div class="label">
                <label for="titleInput">العنوان (Title)</label>
                <div class="meters">
                  <span class="meter-pill" id="titlePx">0px</span>
                  <span class="meter-pill" id="titleCount">0 حرف</span>
                  <span class="state" id="titleState">—</span>
                </div>
              </div>
              <input id="titleInput" type="text" placeholder="مُوجَّه للضغط – يُفضّل ≤ 60 حرفًا / 580px">
            </div>

            <div class="field">
              <div class="label">
                <label for="descInput">الوصف (Meta)</label>
                <div class="meters">
                  <span class="meter-pill" id="descCount">0 حرف</span>
                  <span class="state" id="descState">—</span>
                </div>
              </div>
              <textarea id="descInput" placeholder="120–160 حرف | فائدة + CTA خفيف | بدون حشو"></textarea>
            </div>

            <div class="field">
              <div class="label">
                <label for="urlInput">الرابط (URL)</label>
                <div class="meters">
                  <span class="meter-pill" id="urlCount">0 حرف</span>
                  <span class="state" id="urlState">—</span>
                </div>
              </div>
              <input id="urlInput" type="text" placeholder="https://yourdomain.com/مسار-الصفحة">
            </div>

            <div class="btns">
              <button class="primary" id="copyTitleBtn">نسخ العنوان</button>
              <button class="primary" id="copyDescBtn">نسخ الوصف</button>
              <button class="primary" id="copyPreviewBtn">نسخ المعاينة كنص</button>
              <button id="clearBtn">مسح الحقول</button>
            </div>
          </section>

          <section class="card section" id="sec-ai" style="grid-area:ai">
            <div class="field" style="margin-bottom:8px">
              <div class="label"><label for="intentInput">نوع الصفحة</label></div>
              <select id="intentInput">
                <option value="article">مقالة</option>
                <option value="product">منتج</option>
                <option value="service">خدمة</option>
                <option value="home">صفحة رئيسية</option>
              </select>
            </div>

            <p class="hint">الصق الوصف (حتى 12000 حرف) وخلي الذكاء الإصطناعي يكمل الباقي</p>
            <textarea id="rawInput" placeholder="الصق وصفًا تفصيليًا هنا..."></textarea>

            <div class="chips">
              <span class="chip" id="wordInfo">0 كلمة</span>
              <div class="ai-actions">
                <button id="generateBtn" class="primary">توليد</button>
                <button id="clearAllBtn">مسح الكل</button>
              </div>
              <span class="chip" id="aiMode" style="display:none">وضع: API</span>
              <span class="chip" id="qualityChip" style="display:none">الجودة: —</span>
            </div>

            <div id="status" class="status hidden"></div>
            <div id="aiErr" class="err" hidden></div>
          </section>

          <section class="preview" id="sec-preview" style="grid-area:preview">
            <div class="serp" id="serp">
              <h3 class="title" id="pTitle">أداة محاكاة مجانية لنتائج بحث جوجل (SERP)</h3>
              <p class="url"><span dir="ltr" id="pUrl">yourdomain.com/أداة-محاكاة-نتائج-بحث</span></p>
              <p class="desc" id="pDesc">وصف تجريبي.</p>
            </div>
            <div class="foot-help">• العنوان يفضّل ≤ 60 حرفًا أو ≈ 580px — الوصف 120–160.</div>
          </section>
        </div>
      </section>
    </div>
  </div>

<script>
/* ===== إعدادات ===== */
const API_BASE = "https://seo-generate.anasshopify88.workers.dev";
const ENDPOINTS = { gen: API_BASE + "/api/generate", ping: API_BASE + "/ping", diag: API_BASE + "/diag" };

/* ✳️ إرشادات حسب نوع الصفحة */
const INTENT_GUIDE = {
  article: `
- العنوان: صياغة تعليمية (سؤال/كيف/دليل) بين 45–60 حرفًا.
- تجنّب نبرة البيع، ركّز على الفائدة والتعلّم.
- الميتا: فكرة أساسية + فائدة واضحة + CTA خفيف.`,
  product: `
- العنوان: [اسم المنتج] — [ميزة/مواصفة رئيسية] | [فئة مختصرة] (≤ 60).
- استخرج من النص (إن وجدت): الاسم/الموديل/السعة/المقاس/اللون/العدد.
- الميتا: نقطة قوة + شحن/إرجاع/ضمان إن ذُكرت. بدون أسعار إن لم ترد بالنص.`,
  service: `
- العنوان: [اسم الخدمة] في [المدينة إن وُجدت] — [نتيجة/فائدة] (≤ 60).
- الميتا: المدة أو نطاق الخدمة + لمن هي موجهة + CTA واضح.`,
  home: `
- العنوان: وعد قيمة مختصر يشرح ماذا تقدّم ولمن (≤ 60).
- الميتا: الأقسام/الفئات الأساسية + USP مختصر + CTA خفيف.`
};

/* قياس البكسل */
(function(){
  const c=document.createElement('canvas'),x=c.getContext('2d');
  window.measurePx=(t,f)=>{x.font=f; return x.measureText(t==null?'':String(t)).width};
})();
const FONTS = {
  title:'800 22px Cairo, Arial, Helvetica, sans-serif',
  desc :'normal 15px Cairo, Arial, Helvetica, sans-serif',
  url  :'normal 14px Cairo, Arial, Helvetica, sans-serif'
};
const ELLIPSIS='…', META_MIN=120, META_MAX=160, TITLE_MAX_PX=580;
const $=s=>document.querySelector(s);

/* عناصر */
const titleInput=$('#titleInput'), descInput=$('#descInput'), urlInput=$('#urlInput');
const pTitle=$('#pTitle'), pUrl=$('#pUrl'), pDesc=$('#pDesc');
const statusEl=$('#status');
const titleCountEl=$('#titleCount'), titlePxEl=$('#titlePx'), titleState=$('#titleState');
const descCountEl=$('#descCount'), descState=$('#descState');
const urlCountEl=$('#urlCount'), urlState=$('#urlState');
const rawInput=$('#rawInput'), qualityChip=$('#qualityChip');

/* أدوات نص */
const charCount = s => Array.from(String(s||'')).length;
const normalizeWS = s => String(s||'').replace(/\s+/g,' ').trim();
const cleanUrlForDisplay = raw => (raw||'').trim().replace(/^https?:\/\//i,'').replace(/^www\./i,'');
const extractDomain = raw => {
  if(!raw) return 'yourdomain.com';
  let s=raw.trim().replace(/^https?:\/\//i,'').replace(/^www\./i,'');
  s=s.split('/')[0].replace(/\/+$/,'');
  return s||'yourdomain.com';
};
const slugFromTitle = t => {
  let s=Array.from(String(t||"")).filter(ch=>/[\u0600-\u06FFA-Za-z0-9 \-]/.test(ch)).join('');
  s=s.replace(/\s+/g,'-').replace(/\-+/g,'-').replace(/^\-|\-$/g,'').toLowerCase();
  return s||'صفحة-جديدة';
};
const availableWidth = el => Math.max(60, Math.floor(el.getBoundingClientRect().width));

function trimToPx(text, limitPx, font){
  let t = String(text||'').trim();
  if (measurePx(t, font) <= limitPx) return t;
  const words=t.split(' ');
  const out=[];
  for (const w of words){
    const test=(out.length? out.join(' ')+' ' : '') + w;
    if (measurePx(test + ELLIPSIS, font) <= limitPx){ out.push(w); } else break;
  }
  if (!out.length){
    let base='';
    for (const ch of t){
      const cand=base+ch;
      if (measurePx(cand+ELLIPSIS,font)<=limitPx) base=cand; else break;
    }
    return (base||t.slice(0,1))+ELLIPSIS;
  }
  return out.join(' ') + ELLIPSIS;
}

const POWER = ['دليل','أفضل','خطوة بخطوة','شامل','سريع','عملي'];
function scoreTitle(t){
  t = normalizeWS(t);
  let s=0;
  if (!t) return 0;
  if (/[0-9]/.test(t)) s+=1;
  if (POWER.some(w=>t.includes(w))) s+=1;
  if (/[|—–\-]/.test(t)) s+=0.5;
  if (charCount(t)>=45 && charCount(t)<=60) s+=1;
  if (!/[!؟]$/.test(t)) s+=0.5;
  return s;
}

function polishTitle(t){
  t = normalizeWS(t).replace(/[“”"']/g,'').replace(/\s*[\|\-—–]\s*/g,' — ').replace(/\s{2,}/g,' ');
  t = t.replace(/\s*(?:…|\.{3,})\s*$/u,'');
  if (charCount(t) > 60){ t = trimToPx(t, TITLE_MAX_PX, FONTS.title); }
  return t;
}
function polishMeta(m, {title}){
  m = normalizeWS(m).replace(/[“”"']/g,'').replace(/\s{2,}/g,' ');
  if (m && title && m.startsWith(title.slice(0, Math.min(20, title.length)))){ m = m.replace(title, '').trim(); }
  if (charCount(m) < META_MIN){
    const addon = ' — تعرّف على التفاصيل وابدأ الآن.';
    const cand = m + addon;
    m = charCount(cand) <= META_MAX ? cand : m;
  }
  if (charCount(m) > META_MAX) m = m.slice(0, META_MAX).replace(/\s+\S*$/,'') + ELLIPSIS;
  m = m.replace(/\s*(?:…|\.{3,})\s*$/u,'');
  return m;
}

function setStatus(kind, msg){
  statusEl.className = 'status ' + (kind||'') + (msg?'':' hidden');
  statusEl.textContent = msg||'';
}

/* عرض المعاينة */
function render(){
  const isMobile = window.matchMedia('(max-width: 1024px)').matches;

  const tRaw = titleInput.value || '';
  const tLen = charCount(tRaw);
  const tPx = Math.round(measurePx(tRaw, FONTS.title));
  titlePxEl.textContent = tPx + 'px';
  titleCountEl.textContent = `${tLen} حرف`;
  titleState.textContent = tLen>60 ? 'طويل (أكثر من 60 حرف)' : (tLen<35 ? 'قصير' : 'مناسب');
  titleState.className = 'state ' + (tLen>60 ? 'bad' : (tLen<35 ? 'warn' : 'ok'));

  pTitle.textContent = tRaw || 'أداة محاكاة مجانية لنتائج بحث جوجل (SERP)';
  if (tLen <= 60) pTitle.classList.add('full'); else pTitle.classList.remove('full');

  const dom = extractDomain(urlInput.value || 'yourdomain.com');
  if (!/https?:\/\//i.test(urlInput.value)){
    urlInput.value = 'https://' + dom + '/' + slugFromTitle(pTitle.textContent || 'أداة-محاكاة-نتائج-بحث');
  }

  if (isMobile){
    pUrl.textContent = cleanUrlForDisplay(urlInput.value || 'yourdomain.com/slug');
  }else{
    const urlLimit = availableWidth(pUrl.parentElement);
    const s = cleanUrlForDisplay(urlInput.value||'');
    pUrl.textContent = measurePx(s,FONTS.url)<=urlLimit? s : trimToPx(s,urlLimit,FONTS.url);
  }
  urlCountEl.textContent = `${charCount(urlInput.value)} حرف`;
  urlState.textContent='—';
  urlState.className='state';

  const dRaw = descInput.value || '';
  descCountEl.textContent = `${charCount(dRaw)} حرف`;
  descState.textContent = (charCount(dRaw)>META_MAX)?'طويل':(charCount(dRaw)<META_MIN?'قصير':'مناسب');
  descState.className = 'state ' + ((charCount(dRaw)>META_MAX)?'bad':(charCount(dRaw)<META_MIN)?'warn':'ok');

  if (isMobile){
    pDesc.textContent = dRaw.trim();
  }else{
    const linePx = availableWidth(pDesc);
    const tokens = String(dRaw).replace(/\n+/g,' ').split(/(\s+)/);
    let lines=['','']; let iLine=0;
    const fits=(curr,tok)=>measurePx(curr+tok, FONTS.desc)<=linePx;
    for (const tok of tokens){
      if (fits(lines[iLine], tok)) lines[iLine]+=tok;
      else{
        iLine++;
        if (iLine>1){
          let second = lines[1].trimEnd();
          while (second && measurePx(second+ELLIPSIS,FONTS.desc)>linePx){ second = second.replace(/\s*\S+$/,''); }
          lines[1]=second+(second?ELLIPSIS:'');
          break;
        }else{
          if (measurePx(tok,FONTS.desc)<=linePx) lines[iLine]=tok.replace(/^\s+/,'');
          else{
            let piece='';
            for (let j=0;j<tok.length;j++){
              const c=piece+tok[j];
              if (measurePx(c,FONTS.desc)<=linePx) piece=c; else break;
            }
            lines[iLine]=piece;
          }
        }
      }
    }
    pDesc.textContent = (lines[0] + (lines[1]? '\n'+lines[1] : '')).trim();
  }

  const sc = scoreTitle(titleInput.value||'');
  qualityChip.textContent = 'الجودة: ' + (sc>=5? 'عالية' : sc>=3? 'متوسطة' : 'منخفضة');
}

/* برومبت للـAPI */
function buildAIPrompt(raw, {intent}){
  const guide = INTENT_GUIDE[intent] || INTENT_GUIDE.article;
  return `
أنت كاتب عناوين ووصف SEO عربي محترف. أعِد نتيجة JSON فقط:
{"title": "...", "meta": "...", "slug": "..."}

قواعد عامة صارمة:
- العنوان بين 45–60 حرفًا، بدون إيموجي/علامات اقتباس/نقاط حذف (…) في النهاية.
- لا تضف سنة ولا براند تلقائيًا.
- الوصف (ميتا) 120–160 حرفًا، لا يكرر العنوان، CTA خفيف، ولا ينتهي بـ ….
- اللغة عربية فصيحة وأسلوب ودي.

إرشادات بحسب النوع:
${guide}

استخرج أي حقائق من النص (أسماء/مواصفات/مدن/فئات) واستخدمها بذكاء داخل الحدود أعلاه.

النص:
"""
${raw}
"""
`.trim();
}

/* استدعاء الـAPI */
async function aiGenerate(prompt, hints){
  const controller = new AbortController();
  const timeout = setTimeout(()=>controller.abort(), 25000);
  let respText = "";
  try{
    const resp = await fetch(ENDPOINTS.gen, {
      method:'POST',
      headers:{'Content-Type':'application/json','Accept':'application/json'},
      body: JSON.stringify({ text: prompt, hints }),
      mode:'cors', cache:'no-store', signal: controller.signal
    });
    clearTimeout(timeout);
    respText = await resp.text();
    if (!resp.ok) throw new Error(respText || `HTTP ${resp.status}`);
    return JSON.parse(respText);
  }catch(err){
    clearTimeout(timeout);
    throw err;
  }
}

function showErrorMessage(eText){
  const el=document.querySelector('#aiErr');
  el.hidden = false;
  el.textContent = eText;
}
function clearError(){
  const el=document.querySelector('#aiErr');
  el.hidden = true;
  el.textContent = "";
}

async function generateFromRaw(){
  clearError(); setStatus('', '');
  let raw = (document.querySelector('#rawInput').value || '');
  if (charCount(raw) > 12000) raw = Array.from(raw).slice(0,12000).join('');

  const hints = { intent: document.querySelector('#intentInput').value };
  const composed = buildAIPrompt(raw, hints);

  const generateBtn=document.querySelector('#generateBtn');
  generateBtn.classList.add('loading');
  generateBtn.textContent='... جاري التوليد';

  try{
    const out = await aiGenerate(composed, hints);
    if (!out || !out.title || !out.meta){ throw new Error('استجابة غير صالحة من الخادم.'); }

    let title = String(out.title||'').trim();
    let meta  = String(out.meta||'').trim();
    title = title.replace(/\s*(?:…|\.{3,})\s*$/u,'');

    const autoPolish=document.querySelector('#autoPolish');
    if (autoPolish && autoPolish.checked){
      const beforeScore = scoreTitle(title);
      const tPolished = polishTitle(title);
      const afterScore = scoreTitle(tPolished);
      if (afterScore >= beforeScore) title = tPolished;
      meta = polishMeta(meta, {title});
    }else{
      if (charCount(title) > 60 && measurePx(title, FONTS.title) > TITLE_MAX_PX){
        title = trimToPx(title, TITLE_MAX_PX, FONTS.title);
      }
      if (charCount(meta) > META_MAX) meta = meta.slice(0, META_MAX).replace(/\s+\S*$/,'') + ELLIPSIS;
      meta = meta.replace(/\s*(?:…|\.{3,})\s*$/u,'');
    }

    document.querySelector('#titleInput').value = title;
    document.querySelector('#descInput').value  = meta;

    const dom = extractDomain(document.querySelector('#urlInput').value || 'yourdomain.com');
    const slug = (out.slug && String(out.slug).trim()) || slugFromTitle(title);
    document.querySelector('#urlInput').value = 'https://' + dom + '/' + slug;

    const sc = scoreTitle(title);
    setStatus(sc>=5?'ok':sc>=3?'warn':'warn', sc>=5?'تم التوليد والتلميع بجودة عالية.':'تم التوليد مع تحسينات موضعية.');

    render();
  }catch(err){
    setStatus('bad', 'فشل الاتصال بالـAPI.');
    showErrorMessage('فشل التوليد: ' + String(err||''));
  }finally{
    generateBtn.classList.remove('loading');
    generateBtn.textContent='توليد';
  }
}

/* init */
(function init(){
  titleInput.value='أداة محاكاة مجانية لنتائج بحث جوجل (SERP)';
  descInput.value='أداة عملية لكتابة عنوان ووصف ورابط يظهران باحتراف في نتائج البحث، مع قص دقيق بالبكسل وبدون حشو.';
  urlInput.value='https://yourdomain.com/' + slugFromTitle(titleInput.value);

  window.addEventListener('resize', render);
  rawInput.addEventListener('input', ()=>{
    const wc=(rawInput.value.trim().match(/[\p{L}\p{N}’']+/gu)||[]).length;
    document.querySelector('#wordInfo').textContent=`${wc} كلمة`;
  });

  titleInput.addEventListener('input', render);
  descInput .addEventListener('input', render);
  urlInput  .addEventListener('input', render);

  const ap=document.querySelector('#autoPolish');
  if (ap) ap.addEventListener('change', ()=>setStatus('', ''));

  document.querySelector('#clearBtn').addEventListener('click', ()=>{
    titleInput.value=''; descInput.value=''; urlInput.value=''; render();
  });
  document.querySelector('#clearAllBtn').addEventListener('click', ()=>{
    rawInput.value='';
    document.querySelector('#wordInfo').textContent='0 كلمة';
    setStatus('', '');
  });

  document.querySelector('#copyTitleBtn').addEventListener('click', ()=>navigator.clipboard.writeText(titleInput.value));
  document.querySelector('#copyDescBtn') .addEventListener('click', ()=>navigator.clipboard.writeText(descInput.value));
  document.querySelector('#copyPreviewBtn').addEventListener('click', ()=>{
    navigator.clipboard.writeText([titleInput.value, cleanUrlForDisplay(urlInput.value), descInput.value].filter(Boolean).join('\n'));
  });

  document.querySelector('#backBtn').addEventListener('click', ()=>history.back());

  document.querySelector('#generateBtn').addEventListener('click', ()=>{
    if (!rawInput.value.trim()){
      rawInput.value = [titleInput.value, descInput.value].join('\n');
      document.querySelector('#wordInfo').textContent=`${(rawInput.value.trim().match(/[\p{L}\p{N}’']+/gu)||[]).length} كلمة`;
    }
    generateFromRaw();
  });

  render();
})();
</script>
</body>
</html>
